---
title: "prod_analysis_spatial"
author: "Aleah Wong"
date: '2023-05-09'
output: html_document
---
```{r}
rm(list = ls())
.rs.restartR()
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyr)
```

START RUNNING FROM BELOW: around line 80 to establish cat_totals

SPATIAL PATTERNS
```{r}
# Spatial analysis: **take average of index for continents from the last ten years**
# By continent, FAO area; look at China and maybe Canada

#calculate mean index of production for EACH: continent, FAO area over the last ten years
```

```{r}
#load in FAO data, calculate total production in each year
inland <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/inland_finfish_prod.csv")
marine <-read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/marine_finfish_prod.csv")
nonfish <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/nonfish_prod.csv")
```

```{r}
#calculate annual production totals for each marine species, for each continent

marine <- marine %>%mutate_at(c(6:77), as.numeric) #change yearly data to numeric

#create list of each continent to loop through
uniquecontinent <- c("Africa", "Americas", "Asia", "Europe", "Oceania")

new_frame <- filter(marine) #create new frame
new_frame <- new_frame[FALSE, ]

#TEST
for (i in 1:5){ #for each of the 5 continents
  u_continent <- filter(marine, Continent.Name.En == uniquecontinent[i], ) #subset one continent
  # print(u_continent$Continent.Name.En[i])
  y <- nrow(new_frame)

  #find sum for each species, each year
  u_species <- unique(u_continent$ASFIS.species.Name.En)

  for (z in 1:length(u_species)) {
    # print(u_species[z])
    uu <- filter(u_continent, ASFIS.species.Name.En == u_species[z], )

      for (b in 6:77){ #for each year; calculate the annual mean each year
        a <- sum(uu[, b], na.rm = TRUE)

        new_frame[y+z, b] <-a

        new_frame[y+z, 1] <- u_species[z] #species name
        new_frame[y+z, 2] <- uniquecontinent[i] #continent

    }
  }
}

new_frame <- new_frame[, c(1, 2, 6:77)] #cut out unnecessary columns
names(new_frame)[1] <- "Species" #rename first column

# #save this data
NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Chapter_2/marine_totals_bycontinent.csv")
write.csv(new_frame,file=NAME)
```

```{r}
#calculate annual production totals for each inland species, for each continent

inland <- inland %>%mutate_at(c(6:77), as.numeric) #change yearly data to numeric

#create list of each continent to loop through
uniquecontinent <- c("Africa", "Americas", "Asia", "Europe", "Oceania")

new_frame <- filter(inland) #create new frame
new_frame <- new_frame[FALSE, ]

#TEST
for (i in 1:5){ #for each of the 5 continents
  u_continent <- filter(inland, Continent.Name.En == uniquecontinent[i], ) #subset one continent
  # print(u_continent$Continent.Name.En[i])
  y <- nrow(new_frame)

  #find sum for each species, each year
  u_species <- unique(u_continent$ASFIS.species.Name.En)

  for (z in 1:length(u_species)) {
    # print(u_species[z])
    uu <- filter(u_continent, ASFIS.species.Name.En == u_species[z], )

      for (b in 6:77){ #for each year; calculate the annual mean each year
        a <- sum(uu[, b], na.rm = TRUE)

        new_frame[y+z, b] <-a

        new_frame[y+z, 1] <- u_species[z] #species name
        new_frame[y+z, 2] <- uniquecontinent[i] #continent

    }
  }
}

new_frame <- new_frame[, c(1, 2, 6:77)] #cut out unnecessary columns
names(new_frame)[1] <- "Species" #rename first column

# #save this data
NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Chapter_2/inland_totals_bycontinent.csv")
write.csv(new_frame,file=NAME)
```

```{r}
#calculate annual production totals for each nonfish species, for each continent
#change for marine and nonfish!

nonfish <- nonfish %>%mutate_at(c(6:77), as.numeric) #change yearly data to numeric

#create list of each continent to loop through
uniquecontinent <- c("Africa", "Americas", "Asia", "Europe", "Oceania")

new_frame <- filter(nonfish) #create new frame
new_frame <- new_frame[FALSE, ]

#TEST
for (i in 1:5){ #for each of the 5 continents
  u_continent <- filter(nonfish, Continent.Name.En == uniquecontinent[i], ) #subset one continent
  # print(u_continent$Continent.Name.En[i])
  y <- nrow(new_frame)

  #find sum for each species, each year
  u_species <- unique(u_continent$ASFIS.species.Name.En)

  for (z in 1:length(u_species)) {
    # print(u_species[z])
    uu <- filter(u_continent, ASFIS.species.Name.En == u_species[z], )

      for (b in 6:77){ #for each year; calculate the annual mean each year
        a <- sum(uu[, b], na.rm = TRUE)

        new_frame[y+z, b] <-a

        new_frame[y+z, 1] <- u_species[z] #species name
        new_frame[y+z, 2] <- uniquecontinent[i] #continent

    }
  }
}

new_frame <- new_frame[, c(1, 2, 6:77)] #cut out unnecessary columns
names(new_frame)[1] <- "Species" #rename first column

# #save this data
NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Chapter_2/nonfish_totals_bycontinent.csv")
write.csv(new_frame,file=NAME)
```

Calculating production totals
```{r}
#load data
inland_totals_cont <- read.csv("/Users/aleahw/Documents/Master's!!/Chapter_2/inland_totals_bycontinent.csv")
marine_totals_cont <- read.csv("/Users/aleahw/Documents/Master's!!/Chapter_2/marine_totals_bycontinent.csv")
nonfish_totals_cont <- read.csv("/Users/aleahw/Documents/Master's!!/Chapter_2/nonfish_totals_bycontinent.csv")

#rename (inland and marine) for nile tilapia and rainbow trout
inland_totals_cont$Species[inland_totals_cont$Species == "Rainbow trout"] <- "Oncorhynchus mykiss (inland)"
inland_totals_cont$Species[inland_totals_cont$Species == "Nile tilapia"] <- "Oreochromis niloticus (inland)"

#rename (inland and marine) for nile tilapia and rainbow trout
marine_totals_cont$Species[marine_totals_cont$Species == "Rainbow trout"] <- "Oncorhynchus mykiss (marine)"
marine_totals_cont$Species[marine_totals_cont$Species == "Nile tilapia"] <- "Oreochromis niloticus (marine)"

#combine the datasets with rowbind
cat_totals <- rbind(inland_totals_cont, marine_totals_cont)
cat_totals <- rbind(cat_totals, nonfish_totals_cont)
cat_totals <- cat_totals[, c(-1)]

#rename pompano, get rid of nori nei, scallops nei and sea mussels nei
cat_totals <- cat_totals[!cat_totals$Species == "Nori nei",]
cat_totals <- cat_totals[!cat_totals$Species == "Scallops nei",]
cat_totals <- cat_totals[!cat_totals$Species == "Sea mussels nei",]
```

```{r}
#put both datasets into the same order so the species line up
#rename the cat_totals species to be scientific names

cat_totals$Species[cat_totals$Species == "American cupped oyster"] <- "Crassostrea virginica"
cat_totals$Species[cat_totals$Species == "North African catfish"] <- "Clarias gariepinus"
cat_totals$Species[cat_totals$Species == "Pompano"] <- "Trachinotus ovatus"

cat_totals$Species[cat_totals$Species == "Black carp"] <- "Mylopharyngodon piceus"
cat_totals$Species[cat_totals$Species == "Bighead carp"] <- "Hypophthalmichthys nobilis"
cat_totals$Species[cat_totals$Species == "Catla"] <- "Catla catla"
cat_totals$Species[cat_totals$Species == "Common carp"] <- "Cyprinus carpio"
cat_totals$Species[cat_totals$Species == "Crucian carp"] <- "Carassius carassius"
cat_totals$Species[cat_totals$Species == "Grass carp(=White amur)"] <- "Ctenopharyngodon idellus"
cat_totals$Species[cat_totals$Species == "Largemouth black bass"] <- "Micropterus salmoides"
cat_totals$Species[cat_totals$Species == "Nile tilapia"] <- "Oreochromis niloticus"
cat_totals$Species[cat_totals$Species == "Rainbow trout"] <- "Oncorhynchus mykiss"
cat_totals$Species[cat_totals$Species == "Roho labeo"] <- "Labeo rohita"
cat_totals$Species[cat_totals$Species == "Silver carp"] <- "Hypophthalmichthys molitrix"
cat_totals$Species[cat_totals$Species == "Striped catfish"] <- "Pangasianodon hypophthalmus"
cat_totals$Species[cat_totals$Species == "Wuchang bream"] <- "Megalobrama amblycephala"
cat_totals$Species[cat_totals$Species == "Atlantic salmon"] <- "Salmo salar"
cat_totals$Species[cat_totals$Species == "Barramundi(=Giant seaperch)"] <- "Lates calcarifer"
cat_totals$Species[cat_totals$Species == "Coho(=Silver) salmon"] <- "Oncorhynchus kisutch"
cat_totals$Species[cat_totals$Species == "European seabass"] <- "Dicentrarchus labrax"
cat_totals$Species[cat_totals$Species == "Flathead grey mullet"] <- "Mugil cephalus"
cat_totals$Species[cat_totals$Species == "Gilthead seabream"] <- "Sparus aurata"
cat_totals$Species[cat_totals$Species == "Japanese amberjack"] <- "Seriola quinqueradiata"
cat_totals$Species[cat_totals$Species == "Japanese seabass"] <-  "Lateolabrax japonicus"
cat_totals$Species[cat_totals$Species == "Large yellow croaker"] <- "Larimichthys croceus"
cat_totals$Species[cat_totals$Species == "Milkfish"] <- "Chanos chanos"
cat_totals$Species[cat_totals$Species == "Nile tilapia"] <- "Oreochromis niloticus"
cat_totals$Species[cat_totals$Species == "Orange-spotted grouper"] <- "Epinephelus coioides"
cat_totals$Species[cat_totals$Species == "Red drum"] <- "Sciaenops ocellatus"
cat_totals$Species[cat_totals$Species == "Blood cockle"] <- "Tegillarca granosa"
cat_totals$Species[cat_totals$Species == "Blue mussel" ] <- "Mytilus edulis"
cat_totals$Species[cat_totals$Species == "Chilean mussel"] <- "Mytilus chilensis"
cat_totals$Species[cat_totals$Species == "Chinese mitten crab" ] <- "Eriocheir sinensis"
cat_totals$Species[cat_totals$Species == "Constricted tagelus"] <- "Sinonovacula constricta"
cat_totals$Species[cat_totals$Species == "Elkhorn sea moss"] <- "Kappaphycus alvarezii"

cat_totals$Species[cat_totals$Species == "Eucheuma seaweeds nei"] <- "Eucheuma cottonii"
cat_totals$Species[cat_totals$Species == "Fusiform sargassum"] <- "Sargassum fusiforme"
cat_totals$Species[cat_totals$Species == "Giant river prawn"] <- "Macrobrachium rosenbergii"
cat_totals$Species[cat_totals$Species == "Giant tiger prawn"] <- "Penaeus monodon"

cat_totals$Species[cat_totals$Species == "Gracilaria seaweeds"] <- "Gracilaria gracilis"
cat_totals$Species[cat_totals$Species == "Green mud crab"] <- "Scylla paramamosain" 
cat_totals$Species[cat_totals$Species == "Indo-Pacific swamp crab"] <- "Scylla serrata"
cat_totals$Species[cat_totals$Species == "Japanese carpet shell"] <- "Ruditapes philippinarum"
cat_totals$Species[cat_totals$Species == "Japanese kelp"] <- "Laminaria japonica"

cat_totals$Species[cat_totals$Species == "Laver (Nori)"] <- "Porphyra"
cat_totals$Species[cat_totals$Species == "Mediterranean mussel"] <- "Mytilus galloprovincialis"
cat_totals$Species[cat_totals$Species == "New Zealand mussel"] <- "Perna canaliculus"

cat_totals$Species[cat_totals$Species == "Oriental river prawn" ] <- "Macrobrachium nipponense"
cat_totals$Species[cat_totals$Species == "Pacific cupped oyster"] <- "Magallana gigas"
cat_totals$Species[cat_totals$Species == "Red swamp crawfish"] <- "Procambarus clarkii"
cat_totals$Species[cat_totals$Species == "Spiny eucheuma"] <- "Eucheuma denticulatum"
cat_totals$Species[cat_totals$Species == "Wakame"] <- "Undaria pinnatifida"
cat_totals$Species[cat_totals$Species == "Whiteleg shrimp"] <- "Penaeus vannamei"
cat_totals$Species[cat_totals$Species == "Yesso scallop" ] <- "Mizuhopecten yessoensis"

```

```{r}
#put rows in alphabetical order
cat_totals <- cat_totals[order(cat_totals$Species), ]

#extra 2 porphyra in species data, create triplicate
cat_totals$Species[131] #131 is porphyra
cat_totals <- rbind(cat_totals, cat_totals[rep(131, 2), ])

#put rows in alphabetical order
cat_totals <- cat_totals[order(cat_totals$Species), ]

#and name each one a diff species??
cat_totals$Species[131] <- "Porphrya tenera"
cat_totals$Species[132] <- "Porphyra haitanensis"
cat_totals$Species[133] <- "Porphyra yezoensis"

#put rows in alphabetical order
cat_totals <- cat_totals[order(cat_totals$Species), ]

#fix
# cat_totals$Species[cat_totals$Species == "Ctenopharyngodon idella"] <- "Ctenopharyngodon idellus"

#save cat_totals
NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Chapter_2/prod_by_cat.csv")
write.csv(cat_totals,file=NAME)
```

#check for missing sp?
```{r}
unique(cat_totals$Species) #should be 57 when including China
```

PRODUCTION TOTALS by CONTINENT
```{r}
str(cat_totals)

cat_totals <- cat_totals %>%mutate_at(c(3:74), as.numeric) #change yearly data to numeric
names(cat_totals)[2] <- "Continent" #rename continent column

new_frame <- cat_totals #create new frame
new_frame <- new_frame[FALSE, ]

#now add the totals for other categories
#create list of each continent to loop through
unique <- c("Africa", "Americas", "Asia", "Europe", "Oceania") 

for (i in 1:length(unique)){ #for each of the continents
  u_cont <- filter(cat_totals, Continent == unique[i])
  
#calculate the annual prod each year

  for (b in 3:74){
    a <- sum(u_cont[, b], na.rm = TRUE)
    print(a)
    new_frame[i, 2] <- unique[i]
    new_frame[i, b] <-a #change row number 
  }
}

new_frame <- new_frame[, c(2, 3:74)] #cut out unnecessary columns

#save this data
NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Chapter_2/category_totals_bycontinent.csv")
write.csv(new_frame,file=NAME)
```

```{r}
#load in the FCB scores data
speciesdata <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/FCB_scores_825.2.csv")

#rename (inland and marine) for nile tilapia and rainbow trout
speciesdata$species[34] <- "Oncorhynchus mykiss (inland)"
speciesdata$species[35] <- "Oncorhynchus mykiss (marine)"
speciesdata$species[36] <- "Oreochromis niloticus (inland)"
speciesdata$species[37] <- "Oreochromis niloticus (marine)"
```


#start from here?
```{r}
#load in the totals
totals <- read.csv("/Users/aleahw/Documents/Master's!!/Chapter_2/category_totals_bycontinent.csv")

cat_totals <- read.csv("/Users/aleahw/Documents/Master's!!/Chapter_2/prod_by_cat.csv")

#need to delete first column for this one only
cat_totals <- cat_totals[, c(-1)]
```

WEIGHTED BY ALL PRODUCTION (CHANGE for B and C)
```{r}

new_frame <- cat_totals #create new frame
new_frame <- new_frame[FALSE, ]
  
for (i in 1:nrow(speciesdata)){ #for each species
  y <- nrow(new_frame) #reset nrow
  sp <- speciesdata$species[i] #get one species
  f_score <- speciesdata$f[i] #get the score for the species, CHANGE FOR B AND C
  #good to here
  set <- filter(cat_totals, Species == sp, )
  # print(set$Species)

        
  for (z in 1:nrow(set)) { #for each row in the species set (for each continent)
    for (b in 3:74) { #for each year
      index <- f_score*set[z, b] #multiply score by that species' total production in each year
      # print(index)
      new_frame[y+z, b] <- index   #add these numbers to the frame
      new_frame[y+z, 1] <- speciesdata[i, 2] #add species
      new_frame[y+z, 2] <- set$Continent.Name.En[z] #add continent

      if(is.na(set$Continent.Name.En[z])) {x=FALSE
    } else if (set$Continent.Name.En[z] == "Africa") {
    index <- index/totals[1, b]
    } else if (set$Continent.Name.En[z] == "Americas") {
    index <- index/totals[2, b]
    } else if (set$Continent.Name.En[z] == "Asia") {
    index <- index/totals[3, b]
    } else if (set$Continent.Name.En[z] == "Europe") {
    index <- index/totals[4, b]
    } else
    index <- index/totals[5, b]

      new_frame[y+z, b] <- index   #add these numbers to the frame
      new_frame[y+z, 1] <- speciesdata[i, 2] #add species
      new_frame[y+z, 2] <- set$Continent.Name.En[z] #add continent

      }
    }
}

```

```{r}
#calculate the annual mean each year, for each continent
weighted_indexes <- new_frame #create new frame
weighted_indexes <- weighted_indexes[FALSE, ]

#select one continent at a time, then sum all values for each year
#create list of each continent to loop through
unique <- c("Africa", "Americas", "Asia", "Europe", "Oceania") 

for (i in 1:length(unique)){ #for each of the continents
  u_cont <- filter(new_frame, Continent.Name.En == unique[i], )
  y <- nrow(new_frame) #reset nrow
  
#calculate the annual mean each year
  for (b in 3:74){
    a <- sum(u_cont[, b], na.rm = TRUE)
    print(a)
    
    #how to store?
    weighted_indexes[i, b] <- a   #add these numbers to the frame
    weighted_indexes[i, 2] <- unique[i] #add continent
  }
}

weighted_indexes <- weighted_indexes[, 2:74] #new frame with just the weighted scores each year
```

```{r}
#separate out the continents
africa <- weighted_indexes[1, ]
americas <- weighted_indexes[2, ]
asia <- weighted_indexes[3, ]
europe <- weighted_indexes[4, ]
oceania <- weighted_indexes[5, ]

library(tidyr)
#make long, change for each continent
oceania <- pivot_longer(oceania, cols = c(!Continent.Name.En), 
                                names_to = "Year", values_to = "Score")


oceania <- oceania[order(oceania$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)


#rename year column in weighted_indexes
for (i in 1:nrow(oceania)) {
  print(oceania$Year[i])
  #replace each year with the actual year number from year_labs
  
  oceania$Year[i] <- year_labs[i]
}

oceania$Year <- as.numeric(oceania$Year) #make years numeric

#make long, africa
africa <- pivot_longer(africa, cols = c(!Continent.Name.En), 
                                names_to = "Year", values_to = "Score")


africa <- africa[order(africa$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)


#rename year column in weighted_indexes
for (i in 1:nrow(africa)) {
  print(africa$Year[i])
  #replace each year with the actual year number from year_labs
  
  africa$Year[i] <- year_labs[i]
}

africa$Year <- as.numeric(africa$Year) #make years numeric

#make long, asia
asia <- pivot_longer(asia, cols = c(!Continent.Name.En), 
                                names_to = "Year", values_to = "Score")


asia <- asia[order(asia$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)


#rename year column in weighted_indexes
for (i in 1:nrow(asia)) {
  print(asia$Year[i])
  #replace each year with the actual year number from year_labs
  
  asia$Year[i] <- year_labs[i]
}

asia$Year <- as.numeric(asia$Year) #make years numeric

#make long, americas
americas <- pivot_longer(americas, cols = c(!Continent.Name.En), 
                                names_to = "Year", values_to = "Score")


americas <- americas[order(americas$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)


#rename year column in weighted_indexes
for (i in 1:nrow(americas)) {
  print(americas$Year[i])
  #replace each year with the actual year number from year_labs
  
  americas$Year[i] <- year_labs[i]
}

americas$Year <- as.numeric(americas$Year) #make years numeric

#make long, europe
europe <- pivot_longer(europe, cols = c(!Continent.Name.En), 
                                names_to = "Year", values_to = "Score")


europe <- europe[order(europe$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)


#rename year column in weighted_indexes
for (i in 1:nrow(europe)) {
  print(europe$Year[i])
  #replace each year with the actual year number from year_labs
  
  europe$Year[i] <- year_labs[i]
}

europe$Year <- as.numeric(europe$Year) #make years numeric
```

GRAPHING
```{r}
#graphing this
library(ggplot2)
setwd("/Users/aleahw/Documents/Master's!!/Chapter_2")

ggplot(africa, aes(x=Year, y=Score)) +geom_point()+
  labs(y = "Mean F Index", title = "F Potential of Aquaculture in Africa")+
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))

#change both axes titles, main title

#SAVE
# ggsave("F_africa.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set
```

```{r}
#combining all continents into one graph?

#make long
weighted_indexes <- pivot_longer(weighted_indexes, cols = c(!Continent.Name.En),
                                names_to = "Year", values_to = "Score")


weighted_indexes <- weighted_indexes[order(weighted_indexes$Year),] #put earlier years first
# 
year_labs <- seq(1950, 2021, by = 1)
year_labs


#make alphabetical so all years for one continent are together
weighted_indexes <- weighted_indexes[order(weighted_indexes$Continent.Name.En), ]


#rename year column in weighted_indexes for africa
for (i in 1:72) {
  print(weighted_indexes$Year[i])
  #replace each year with the actual year number from year_labs

  weighted_indexes$Year[i] <- year_labs[i]
}

weighted_indexes$Year <- as.numeric(weighted_indexes$Year) #make years numeric

#rename years for americas
for (i in 73:144) {
  print(weighted_indexes$Year[i-72])
  #replace each year with the actual year number from year_labs

  weighted_indexes$Year[i] <- year_labs[i-72]
}

weighted_indexes$Year <- as.numeric(weighted_indexes$Year) #make years numeric

#rename years for asia
for (i in 145:216) {
  print(weighted_indexes$Year[i-144])
  #replace each year with the actual year number from year_labs

  weighted_indexes$Year[i] <- year_labs[i-144]
}

weighted_indexes$Year <- as.numeric(weighted_indexes$Year) #make years numeric

#rename years for europe
for (i in 217:288) {
  print(weighted_indexes$Year[i-216])
  #replace each year with the actual year number from year_labs

  weighted_indexes$Year[i] <- year_labs[i-216]
}

weighted_indexes$Year <- as.numeric(weighted_indexes$Year) #make years numeric

#rename years for oceania
for (i in 289:360) {
  print(weighted_indexes$Year[i-288])
  #replace each year with the actual year number from year_labs

  weighted_indexes$Year[i] <- year_labs[i-288]
}

weighted_indexes$Year <- as.numeric(weighted_indexes$Year) #make years numeric
```

```{r}
plot <- ggplot(weighted_indexes, aes(x=Year, y=Score, color = Continent.Name.En)) +geom_line(size =1)+
  labs(y = "Mean Biodiversity Index", title = "Biodiversity Potential of Aquaculture", color = "Continent")+
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))+

      scale_color_manual(values=c('#7D627F', '#BA714F', '#F4B9B2', '#C0E08F', '#7DBBC3'))

#change colors for color-blind friendly

#SAVE
# ggsave("B_all_continents.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set


#just the 20-year version:
plot <- ggplot(weighted_indexes, aes(x=Year, y=Score, color = Continent.Name.En)) +geom_point(size =1)+ geom_line()+
  labs(y = "Mean Biodiversity Index", title = "Biodiversity Potential of Aquaculture", color = "Continent")+
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))+
  
      scale_color_manual(values=c('#7D627F', '#BA714F', '#F4B9B2', '#C0E08F', '#7DBBC3'))+
        xlim(1980, 2021)

#SAVE
# ggsave("B_all_continents_1980-2021.png", plot, height = 5, width = 8, dpi = 600) #make sure wd is set

#just the last 5 years version:
# ggplot(weighted_indexes, aes(x=Year, y=Score, color = Continent.Name.En)) +geom_line(size =1)+ geom_line()+
#   labs(y = "Mean Food Security Index", title = "Food Security Potential of Aquaculture")+
#     theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))+
#   
#       scale_color_manual(values=c('#7D627F', '#BA714F', '#F4B9B2', '#C0E08F', '#7DBBC3'))+
#         xlim(2000, 2021)

#where are the analyzed (top-farmed) species actually being farmed? probably not in Oceania>????
```

################################################################################################

```{r}
#find continent averages over different time periods (F, C and B)
#run code chunk above to make weighted_indexes long (since 362)

#5-year average for each continent for: (1980-1985) and (2016-2021)

mean_80_85 <- weighted_indexes %>% group_by(Continent.Name.En) %>% 
  filter(Year %in% c(1980, 1981, 1982, 1983, 1984, 1985)) %>%
  summarise(mean_80_85 = mean(Score))

mean_16_21 <- weighted_indexes %>% group_by(Continent.Name.En) %>% 
  filter(Year %in% c( 2016, 2017, 2018, 2019, 2020, 2021)) %>%
  summarise(mean_16_21 = mean(Score))

means <- merge(mean_80_85, mean_16_21, by = c("Continent.Name.En"))

mean_50_80 <- weighted_indexes %>% group_by(Continent.Name.En) %>% 
  filter(Year >= 1950 & Year <= 1980) %>%
  summarise(mean_50_80 = mean(Score))

mean_80_00 <- weighted_indexes %>% group_by(Continent.Name.En) %>% 
  filter(Year >= 1980 & Year <= 2000) %>%
  summarise(mean_80_00 = mean(Score))

mean_00_21 <- weighted_indexes %>% group_by(Continent.Name.En) %>% 
  filter(Year >= 2000 & Year <= 2021) %>%
  summarise(mean_00_21 = mean(Score))

means_3_periods <- merge (mean_50_80, mean_80_00, by = c("Continent.Name.En"))
means_3_periods <- merge (means_3_periods, mean_00_21, by = c("Continent.Name.En"))

#make long
means_3_periods <- pivot_longer(means_3_periods, cols = c(!Continent.Name.En), 
                                names_to = "Period", values_to = "Mean")


#plotting

ggplot(means_3_periods, aes(x = Period, y=Mean, color = Continent.Name.En))+ geom_boxplot()+
  scale_x_discrete(limits = c("mean_50_80", "mean_80_00", "mean_00_21"))+
  scale_y_continuous(limits = c(40, 70))

# getwd()
#SAVE
# ggsave("mean_B_continent_3_periods.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set

#comparing last 5 years to baseline 1980-1985

#make long
means <- pivot_longer(means, cols = c(!Continent.Name.En),
                                names_to = "Period", values_to = "Mean")


ggplot(means, aes(x = Period, y=Mean, color = Continent.Name.En))+ geom_boxplot()+
  scale_x_discrete(limits = c("mean_80_85", "mean_16_21"))+
  scale_y_continuous(limits = c(40, 70))

# ggsave("mean_C_continent_recent_vs_80.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set



```

```{r}
#boxplots for three different periods

means_3_periods <- weighted_indexes

means_3_periods$Year[means_3_periods$Year >= 1950 & means_3_periods$Year <= 1980] <- "1950-1980_mean"
means_3_periods$Year[means_3_periods$Year >= 1981 & means_3_periods$Year <= 2000] <- "1981-2000_mean"
means_3_periods$Year[means_3_periods$Year >= 2001 & means_3_periods$Year <= 2021] <- "2001-2021_mean"

ggplot(means_3_periods, aes(x = Year, y=Score, color = Continent.Name.En))+ geom_boxplot()+
  scale_x_discrete(limits = c("1950-1980_mean", "1981-2000_mean", "2001-2021_mean"))+
  scale_y_continuous(limits = c(40, 70))

#boxplots for two different periods
now_then_means <- weighted_indexes

now_then_means <- filter(now_then_means, Year %in% c(1980, 1981, 1982, 1983, 1984, 1985, 2016, 2017, 2018, 2019, 2020, 2021))


now_then_means$Year[now_then_means$Year == 1980 |now_then_means$Year == 1981 |now_then_means$Year == 1982 |now_then_means$Year == 1983 |now_then_means$Year == 1984 |now_then_means$Year == 1985] <- "1980-1985_mean"

now_then_means$Year[now_then_means$Year == 2016 |now_then_means$Year == 2017 |now_then_means$Year == 2018 |now_then_means$Year == 2019 |now_then_means$Year == 2020 |now_then_means$Year == 2021] <- "2016-2021_mean"

ggplot(now_then_means, aes(x = Year, y=Score, color = Continent.Name.En))+ geom_boxplot()+
  scale_x_discrete(limits = c("1980-1985_mean", "2016-2021_mean"))+
  scale_y_continuous(limits = c(40, 70))
```

##################################################################################################

```{r t-tests to compare most recent 5 years with 1980-1985}
#now run two-sample Welch t-tests, post-hoc
#test that distributions are equal? or use welch's test (default) which does not assume equal variances

now_then_means <- weighted_indexes %>%
  pivot_wider(names_from = "Continent.Name.En", values_from = "Score")

now_then_means <- filter(now_then_means, Year %in% c(1980, 1981, 1982, 1983, 1984, 1985, 2016, 2017, 2018, 2019, 2020, 2021))


now_then_means$Year[now_then_means$Year == 1980 |now_then_means$Year == 1981 |now_then_means$Year == 1982 |now_then_means$Year == 1983 |now_then_means$Year == 1984 |now_then_means$Year == 1985] <- "1980-1985_mean"

now_then_means$Year[now_then_means$Year == 2016 |now_then_means$Year == 2017 |now_then_means$Year == 2018 |now_then_means$Year == 2019 |now_then_means$Year == 2020 |now_then_means$Year == 2021] <- "2016-2021_mean"

#store the continents' p values in a dataframe
#blank dataframe, rename columns, 5 rows
table = data.frame(matrix(nrow = 5, ncol = 2))
names(table)[1] <- "Continent"
names(table)[2] <- "p_value"

#t-tests comparing the 1980-1985 mean with the 2016-2021 mean
for (i in 2:6) { #for each continent
  column <- now_then_means[, i]
  print(column)
  
  continent_name <- colnames(now_then_means[i]) #fix
  print(continent_name)
  
  res <- t.test(unlist(column) ~ Year, data = now_then_means)
  
  p <- res$p.value
  
  #store in table
  table$p_value[i-1] <- p
  table$Continent[i-1] <- continent_name
}

# as.numeric(table$p_value)
# str(table$p_value)

# #replace non-sig p-vals with "> 0.05"
# for (i in 1:nrow(table)) {
#   if (table$p_value[i] > 5e-02){
#     print(table$p_value[i])
#     print("not sig")
#     table$p_value[i] <- "> 0.05" #replace the value in the table with ">0.05"
#   } else {print("sig")
#          } 
# }
##################################################################################################

#POST-HOC
#Performs Games-Howell test, which is used to compare all possible combinations of group differences when the assumption of homogeneity of variances is violated. This post hoc test provides confidence intervals for the differences between group means and shows whether the differences are statistically significant.

# now_then_means %>%
#   group_by(supp) %>%
#   games_howell_test(len ~ dose)

games_howell_test(now_then_means, Africa ~ Year, conf.level = 0.95, detailed = FALSE)

#testing normality
qqPlot(means$b)
```

```{r t-test for 3 different time periods}

means_3_periods <- weighted_indexes %>%
  pivot_wider(names_from = "Continent.Name.En", values_from = "Score")

means_3_periods$Year[means_3_periods$Year >= 1950 & means_3_periods$Year <= 1980] <- "1950-1980_mean"
means_3_periods$Year[means_3_periods$Year >= 1981 & means_3_periods$Year <= 2000] <- "1981-2000_mean"
means_3_periods$Year[means_3_periods$Year >= 2001 & means_3_periods$Year <= 2021] <- "2001-2021_mean"

#testing normality
shapiro.test(means_3_periods$Africa) #significantly diff from normal: p-value = 3.889e-10
shapiro.test(means_3_periods$Asia) #not normal; p-value = 0.001663
shapiro.test(means_3_periods$Europe) #not normal; p-value = 1.642e-09
shapiro.test(means_3_periods$Americas) #not normal: p-value = 9.988e-05
shapiro.test(means_3_periods$Oceania) #not normal: p-value = 2.725e-06

ggplot(means_3_periods) +
  aes(x = Year, y = Africa, color = Year) +
  geom_jitter() +
  theme(legend.position = "none")
  # + ylim(48, 55)
#2000-2021 has greater variance

ggplot(means_3_periods) +
  aes(x = Year, y = Asia, color = Year) +
  geom_jitter() +
  theme(legend.position = "none")+
  ylim(48, 55)

ggplot(means_3_periods) +
  aes(x = Year, y = Europe, color = Year) +
  geom_jitter() +
  theme(legend.position = "none")+
  ylim(48, 55)

ggplot(means_3_periods) +
  aes(x = Year, y = Americas, color = Year) +
  geom_jitter() +
  theme(legend.position = "none")+
  ylim(48, 55)

ggplot(means_3_periods) +
  aes(x = Year, y = Oceania, color = Year) +
  geom_jitter() +
  theme(legend.position = "none")+
  ylim(48, 55)

# library(car)
qqPlot(means_3_periods$Africa)
qqPlot(means_3_periods$Asia)
qqPlot(means_3_periods$Europe)
qqPlot(means_3_periods$Americas)
qqPlot(means_3_periods$Oceania)

#log transform?
means_3_periods$Africa <- log(means_3_periods$Africa)
qqPlot(means_3_periods$Africa)
means_3_periods$Asia <- log(means_3_periods$Asia)
qqPlot(means_3_periods$Asia)
means_3_periods$Europe <- log(means_3_periods$Europe)
qqPlot(means_3_periods$Europe)
means_3_periods$Americas <- log(means_3_periods$Americas)
qqPlot(means_3_periods$Americas)
means_3_periods$Oceania <- log(means_3_periods$Oceania)
qqPlot(means_3_periods$Oceania)

#kruskal wallis?
(kruskal.test(Africa ~ Year, data = means_3_periods))

res <- aov(unlist(Africa) ~ Year, data = means_3_periods)
summary(res)


# Tukey HSD test:
library(multcompView)
# What is the effect of the time period on the score ?
#AFRICA
model=lm(means_3_periods$Africa ~ means_3_periods$Year)
ANOVA=aov(model)
 
# Tukey test to study each pair of treatment :
TukeyHSD(x=ANOVA, 'means_3_periods$Year', conf.level=0.95)
TUKEY <- TukeyHSD(x=ANOVA, 'means_3_periods$Year', conf.level=0.95)

summary(TUKEY)

# Tuckey test representation :
plot(TUKEY , las=1 , col="brown", main = "Title", cex.axis=1)

#ASIA
model=lm(means_3_periods$Asia ~ means_3_periods$Year)
ANOVA=aov(model)
# Tukey test to study each pair of treatment :
TukeyHSD(x=ANOVA, 'means_3_periods$Year', conf.level=0.95)
TUKEY <- TukeyHSD(x=ANOVA, 'means_3_periods$Year', conf.level=0.95)
# Tukey test representation :
plot(TUKEY , las=1 , col="brown")



####################

#store the continents' p values in a dataframe
#blank dataframe, rename columns, 5 rows
table = data.frame(matrix(nrow = 5, ncol = 2))
names(table)[1] <- "Continent"
names(table)[2] <- "p_value"

#t-tests comparing the 1980-1985 mean with the 2016-2021 mean
for (i in 2:6) { #for each continent
  column <- now_then_means[, i]
  print(column)
  
  continent_name <- colnames(now_then_means[i]) #fix
  print(continent_name)
  
  res <- t.test(unlist(column) ~ Year, data = now_then_means)
  
  p <- res$p.value
  
  #store in table
  table$p_value[i-1] <- p
  table$Continent[i-1] <- continent_name
}


games_howell_test(now_then_means, Africa ~ Year, conf.level = 0.95, detailed = FALSE)
```

- Find 5 year average for last five years and from 1980-1985 (for each continent, globally?)
  - Kite plot
  - with and without China incuded
- Find each continent's mean score for each of the three major periods
  - Plot Asia with and without China included
  - Dot/boxplot

################################################################################################

 Current top 5 species over time, by continent
```{r}
setwd("/Users/aleahw/Documents/Master's!!/Fuzzy/Figures")

#filter out just Africa
africa <- subset(cat_totals, Continent=='Africa')

#filter out top 5 species in 2021
# africa1 <- africa[c("Species", "Continent", "X2021")]
africa <- africa[order(africa$X2021,decreasing = TRUE),]
africa <- africa[1:5,]

#make long
africa <- pivot_longer(africa, cols = c(!Species & !Continent),
                                names_to = "Year", values_to = "Production")


africa <- africa[order(africa$Year),] #put earlier years first

# year_labs <- seq(1950, 2021, by = 1)

year_labs <- rep(1950:2021, times=1, each=5)

#rename year column in weighted_indexes
for (i in 1:nrow(africa)) {
  print(africa$Year[i])
  #replace each year with the actual year number from year_labs
  
  africa$Year[i] <- year_labs[i]
}

africa$Year <- as.numeric(africa$Year) #make years numeric

#graph
plot <- ggplot(data = africa, aes(fill=Species, y=Production, x=Year)) + 
  geom_bar(position="stack", stat="identity") +
  labs(y = "Production (tons??)", title = "African Aquaculture Production by Species")

#SAVE
# ggsave("Species_africa.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set




###############################################
#filter out just Asia
asia <- subset(cat_totals, Continent=='Asia')

#filter out top 5 species in 2021
asia <- asia[order(asia$X2021,decreasing = TRUE),]
asia <- asia[1:10,]

#make long
asia <- pivot_longer(asia, cols = c(!Species & !Continent),
                                names_to = "Year", values_to = "Production")


asia <- asia[order(asia$Year),] #put earlier years first

# year_labs <- seq(1950, 2021, by = 1)

year_labs <- rep(1950:2021, times=1, each=10)

#rename year column in weighted_indexes
for (i in 1:nrow(asia)) {
  print(asia$Year[i])
  #replace each year with the actual year number from year_labs
  
  asia$Year[i] <- year_labs[i]
}

asia$Year <- as.numeric(asia$Year) #make years numeric

#graph
plot <- ggplot(data = asia, aes(fill=Species, y=Production, x=Year)) + 
  geom_bar(position="stack", stat="identity")+
  labs(y = "Production (tons??)", title = "Asian Aquaculture Production by Species")

ggsave("Species_asia.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set
##################################################

#filter out just Europe
asia <- subset(cat_totals, Continent=='Europe')

#filter out top 5 species in 2021
asia <- asia[order(asia$X2021,decreasing = TRUE),]
asia <- asia[1:5,]

#make long
asia <- pivot_longer(asia, cols = c(!Species & !Continent),
                                names_to = "Year", values_to = "Production")


asia <- asia[order(asia$Year),] #put earlier years first

# year_labs <- seq(1950, 2021, by = 1)

year_labs <- rep(1950:2021, times=1, each=5)

#rename year column in weighted_indexes
for (i in 1:nrow(asia)) {
  print(asia$Year[i])
  #replace each year with the actual year number from year_labs
  
  asia$Year[i] <- year_labs[i]
}

asia$Year <- as.numeric(asia$Year) #make years numeric

#graph
plot <- ggplot(data = asia, aes(fill=Species, y=Production, x=Year)) + 
  geom_bar(position="stack", stat="identity")+
  labs(y = "Production (tons??)", title = "European Aquaculture Production by Species")

ggsave("Species_europe.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set

######################################################
#filter out just Americas
asia <- subset(cat_totals, Continent=='Americas')

#filter out top 5 species in 2021
asia <- asia[order(asia$X2021,decreasing = TRUE),]
asia <- asia[1:10,]

#make long
asia <- pivot_longer(asia, cols = c(!Species & !Continent),
                                names_to = "Year", values_to = "Production")


asia <- asia[order(asia$Year),] #put earlier years first

# year_labs <- seq(1950, 2021, by = 1)

year_labs <- rep(1950:2021, times=1, each=10)

#rename year column in weighted_indexes
for (i in 1:nrow(asia)) {
  print(asia$Year[i])
  #replace each year with the actual year number from year_labs
  
  asia$Year[i] <- year_labs[i]
}

asia$Year <- as.numeric(asia$Year) #make years numeric

#graph
plot <- ggplot(data = asia, aes(fill=Species, y=Production, x=Year)) + 
  geom_bar(position="stack", stat="identity")+
  labs(y = "Production (tons??)", title = "Aquaculture Production by Species in the Americas")

ggsave("Species_americas.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set
###################################
#filter out just Oceania
asia <- subset(cat_totals, Continent=='Oceania')

#filter out top 5 species in 2021
asia <- asia[order(asia$X2021,decreasing = TRUE),]
asia <- asia[1:5,]

#make long
asia <- pivot_longer(asia, cols = c(!Species & !Continent),
                                names_to = "Year", values_to = "Production")


asia <- asia[order(asia$Year),] #put earlier years first

# year_labs <- seq(1950, 2021, by = 1)

year_labs <- rep(1950:2021, times=1, each=5)

#rename year column in weighted_indexes
for (i in 1:nrow(asia)) {
  print(asia$Year[i])
  #replace each year with the actual year number from year_labs
  
  asia$Year[i] <- year_labs[i]
}

asia$Year <- as.numeric(asia$Year) #make years numeric

#graph
plot <- ggplot(data = asia, aes(fill=Species, y=Production, x=Year)) + 
  geom_bar(position="stack", stat="identity")+
  labs(y = "Production (tons??)", title = "Aquaculture Production by Species in Oceania")

ggsave("Species_oceania.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set

```


```{r}
#PIE CHARTS?
new_frame <- cat_totals #create new frame
new_frame <- new_frame[FALSE, ]
  
for (i in 1:nrow(speciesdata)){ #for each species
  y <- nrow(new_frame) #reset nrow
  sp <- speciesdata$species[i] #get one species
  set <- filter(cat_totals, Species == sp, )
        
  for (z in 1:nrow(set)) { #for each row in the species set (for each continent)
    for (b in 3:74) { #for each year
      index <- set[z, b] #species' total production in each year
      new_frame[y+z, b] <- index   #add these numbers to the frame
      new_frame[y+z, 1] <- speciesdata[i, 2] #add species
      new_frame[y+z, 2] <- set$Continent[z] #add continent

      if(is.na(set$Continent[z])) {x=FALSE
    } else if (set$Continent[z] == "Africa") {
    index <- index/totals[1, b]
    } else if (set$Continent[z] == "Americas") {
    index <- index/totals[2, b]
    } else if (set$Continent[z] == "Asia") {
    index <- index/totals[3, b]
    } else if (set$Continent[z] == "Europe") {
    index <- index/totals[4, b]
    } else
    index <- index/totals[5, b]

      new_frame[y+z, b] <- index   #add these numbers to the frame
      new_frame[y+z, 1] <- speciesdata[i, 2] #add species
      new_frame[y+z, 2] <- set$Continent[z] #add continent

      }
    }
}

#############################
africa <- subset(new_frame, Continent=='Africa')
americas <- subset(new_frame, Continent=='Americas')
asia <- subset(new_frame, Continent=='Asia')
europe <- subset(new_frame, Continent=='Europe')
oceania <- subset(new_frame, Continent=='Oceania')

#GRAPHING
for (i in c(3, 14, 24, 34, 44, 54, 64, 74)){ #for every decade
  df <- europe[, c(1, i)] #make dataframe with just one year
  yr <- 2024-i
  colnames(df)[2] = "year"
  #if the percentage of a species is less than 10%, delete the row name
  for (z in 1:nrow(df)){
    if (df[z, 2] < 0.05) {
      df$Species[z] <- ""
    }
  }

  pie(df$year, labels = df$Species, main = yr)

}



```



```{r}
#TEST, percentage of species
new_frame <- cat_totals #create new frame
new_frame <- new_frame[FALSE, ]

for (i in 1:nrow(speciesdata)){ #for each species
  y <- nrow(new_frame) #reset nrow
  sp <- speciesdata$species[i] #get one species
  set <- filter(cat_totals, Species == sp, )
  # print(set$Species)

  for (z in 1:nrow(set)) { #for each row in the species set (for each continent)
    for (b in 3:74) { #for each year
      index <- set[z, b] #species' total production in each year

      if(is.na(set$Continent[z])) {x=FALSE
    } else if (set$Continent[z] == "Africa") {
    index <- index/totals[1, b]
    } else if (set$Continent[z] == "Americas") {
    index <- index/totals[2, b]
    } else if (set$Continent[z] == "Asia") {
    index <- index/totals[3, b]
    } else if (set$Continent[z] == "Europe") {
    index <- index/totals[4, b]
    } else
    index <- index/totals[5, b]

      new_frame[y+z, b] <- index   #add these numbers to the frame
      new_frame[y+z, 1] <- speciesdata[i, 2] #add species
      new_frame[y+z, 2] <- set$Continent[z] #add continent

      }
    }
}

#filter out just Africa
africa <- subset(new_frame, Continent=='Africa')

#select just the top five species each year
# ?????

#make long
africa <- pivot_longer(africa, cols = c(!Species & !Continent),
                                names_to = "Year", values_to = "Score")


africa <- africa[order(africa$Year),] #put earlier years first

# year_labs <- seq(1950, 2021, by = 1)

year_labs <- rep(1950:2021, times=1, each=30)

#rename year column in weighted_indexes
for (i in 1:nrow(africa)) {
  print(africa$Year[i])
  #replace each year with the actual year number from year_labs

  africa$Year[i] <- year_labs[i]
}

africa$Year <- as.numeric(africa$Year) #make years numeric

#graph
ggplot(data = africa, aes(fill=Species, y=Score, x=Year)) +
  geom_bar(position="stack", stat="identity")
# 
# pie <- plot + coord_polar("y", start=0)
# pie
# 
# #test that adds to 1
# sum(africa$X2021)

```


```{r}
#finding correlations between F, C and B
```


CHINA and CANADA
```{r}
#filter out China and Canada from the inland, marine and nonfish FAO data

inland_china <- inland[inland$Country.Name.En %in% c("China", "Canada"),]

marine_china <- marine[marine$Country.Name.En %in% c("China", "Canada"),]

nonfish_china <- nonfish[nonfish$Country.Name.En %in% c("China", "Canada"),]
```

```{r}
#calculate annual production totals for each inland species, for each country
#only need to do this for nonfish, since the yearly totals are already reflected in the datasets for marine, inland (no duplicates)?????

library(dplyr)

nonfish_china <- nonfish_china %>%mutate_at(c(6:77), as.numeric) #change yearly data to numeric

#create list of each country to loop through
uniquecontinent <- c("Canada", "China") 

new_frame <- filter(nonfish_china) #create new frame
new_frame <- new_frame[FALSE, ]

#TEST
for (i in 1:2){ #for each of the 2 countries
  u_continent <- filter(nonfish_china, Country.Name.En == uniquecontinent[i], ) #subset one country at a time
  # print(u_continent$Continent.Name.En[i])
  y <- nrow(new_frame)
  
  #find sum for each species, each year
  u_species <- unique(u_continent$ASFIS.species.Name.En)
  
  for (z in 1:length(u_species)) {
    # print(u_species[z])
    uu <- filter(u_continent, ASFIS.species.Name.En == u_species[z], )
  
      for (b in 6:77){ #for each year; calculate the annual mean each year
        a <- sum(uu[, b], na.rm = TRUE)
        
        new_frame[y+z, b] <-a
        
        new_frame[y+z, 1] <- u_species[z] #species name
        new_frame[y+z, 3] <- uniquecontinent[i] #continent
      
    }
  }
}

new_frame <- new_frame[, c(1, 3, 6:77)] #cut out unnecessary columns
names(new_frame)[1] <- "Species" #rename first column

# #save this data
NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Chapter_2/nonfish_totals_CH_CA.csv")
write.csv(new_frame,file=NAME)
```

Calculating weighted index scores (FIX)
```{r}
#load data
inland_totals_cont <- inland
inland_totals_cont <- inland_totals_cont[, c(1, 3, 6:77)] #cut out unnecessary columns
names(inland_totals_cont)[1] <- "Species" #rename first column

marine_totals_cont <- marine
marine_totals_cont <- marine_totals_cont[, c(1, 3, 6:77)] #cut out unnecessary columns
names(marine_totals_cont)[1] <- "Species" #rename first column

nonfish_totals_cont <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/nonfish_totals_CH_CA.csv")
nonfish_totals_cont <- nonfish_totals_cont[-1] #get rid of first column

#rename (inland and marine) for nile tilapia and rainbow trout
inland_totals_cont$Species[inland_totals_cont$Species == "Rainbow trout"] <- "Oncorhynchus mykiss (inland)"
inland_totals_cont$Species[inland_totals_cont$Species == "Nile tilapia"] <- "Oreochromis niloticus (inland)"

#rename (inland and marine) for nile tilapia and rainbow trout
marine_totals_cont$Species[marine_totals_cont$Species == "Rainbow trout"] <- "Oncorhynchus mykiss (marine)"
marine_totals_cont$Species[marine_totals_cont$Species == "Nile tilapia"] <- "Oreochromis niloticus (marine)"


#combine the datasets with rowbind
cat_totals <- rbind(inland_totals_cont, marine_totals_cont)
cat_totals <- rbind(cat_totals, nonfish_totals_cont)

#rename pompano, get rid of nori nei, scallops nei and sea mussels nei
cat_totals <- cat_totals[!cat_totals$Species == "Nori nei",]
cat_totals <- cat_totals[!cat_totals$Species == "Scallops nei",]
cat_totals <- cat_totals[!cat_totals$Species == "Sea mussels nei",]
```

```{r}
#put both datasets into the same order so the species line up
#rename the cat_totals species to be scientific names

cat_totals$Species[cat_totals$Species == "American cupped oyster"] <- "Crassostrea virginica"
cat_totals$Species[cat_totals$Species == "North African catfish"] <- "Clarias gariepinus"
cat_totals$Species[cat_totals$Species == "Pompano"] <- "Trachinotus ovatus"

cat_totals$Species[cat_totals$Species == "Black carp"] <- "Mylopharyngodon piceus"
cat_totals$Species[cat_totals$Species == "Bighead carp"] <- "Hypophthalmichthys nobilis"
cat_totals$Species[cat_totals$Species == "Catla"] <- "Catla catla"
cat_totals$Species[cat_totals$Species == "Common carp"] <- "Cyprinus carpio"
cat_totals$Species[cat_totals$Species == "Crucian carp"] <- "Carassius carassius"
cat_totals$Species[cat_totals$Species == "Grass carp(=White amur)"] <- "Ctenopharyngodon idellus"
cat_totals$Species[cat_totals$Species == "Largemouth black bass"] <- "Micropterus salmoides"
cat_totals$Species[cat_totals$Species == "Nile tilapia"] <- "Oreochromis niloticus"
cat_totals$Species[cat_totals$Species == "Rainbow trout"] <- "Oncorhynchus mykiss"
cat_totals$Species[cat_totals$Species == "Roho labeo"] <- "Labeo rohita"
cat_totals$Species[cat_totals$Species == "Silver carp"] <- "Hypophthalmichthys molitrix"
cat_totals$Species[cat_totals$Species == "Striped catfish"] <- "Pangasianodon hypophthalmus"
cat_totals$Species[cat_totals$Species == "Wuchang bream"] <- "Megalobrama amblycephala"
cat_totals$Species[cat_totals$Species == "Atlantic salmon"] <- "Salmo salar"
cat_totals$Species[cat_totals$Species == "Barramundi(=Giant seaperch)"] <- "Lates calcarifer"
cat_totals$Species[cat_totals$Species == "Coho(=Silver) salmon"] <- "Oncorhynchus kisutch"
cat_totals$Species[cat_totals$Species == "European seabass"] <- "Dicentrarchus labrax"
cat_totals$Species[cat_totals$Species == "Flathead grey mullet"] <- "Mugil cephalus"
cat_totals$Species[cat_totals$Species == "Gilthead seabream"] <- "Sparus aurata"
cat_totals$Species[cat_totals$Species == "Japanese amberjack"] <- "Seriola quinqueradiata"
cat_totals$Species[cat_totals$Species == "Japanese seabass"] <-  "Lateolabrax japonicus"
cat_totals$Species[cat_totals$Species == "Large yellow croaker"] <- "Larimichthys croceus"
cat_totals$Species[cat_totals$Species == "Milkfish"] <- "Chanos chanos"
cat_totals$Species[cat_totals$Species == "Nile tilapia"] <- "Oreochromis niloticus"
cat_totals$Species[cat_totals$Species == "Orange-spotted grouper"] <- "Epinephelus coioides"
cat_totals$Species[cat_totals$Species == "Red drum"] <- "Sciaenops ocellatus"
cat_totals$Species[cat_totals$Species == "Blood cockle"] <- "Tegillarca granosa"
cat_totals$Species[cat_totals$Species == "Blue mussel" ] <- "Mytilus edulis"
cat_totals$Species[cat_totals$Species == "Chilean mussel"] <- "Mytilus chilensis"
cat_totals$Species[cat_totals$Species == "Chinese mitten crab" ] <- "Eriocheir sinensis"
cat_totals$Species[cat_totals$Species == "Constricted tagelus"] <- "Sinonovacula constricta"
cat_totals$Species[cat_totals$Species == "Elkhorn sea moss"] <- "Kappaphycus alvarezii"

cat_totals$Species[cat_totals$Species == "Eucheuma seaweeds nei"] <- "Eucheuma cottonii"
cat_totals$Species[cat_totals$Species == "Fusiform sargassum"] <- "Sargassum fusiforme"
cat_totals$Species[cat_totals$Species == "Giant river prawn"] <- "Macrobrachium rosenbergii"
cat_totals$Species[cat_totals$Species == "Giant tiger prawn"] <- "Penaeus monodon"

cat_totals$Species[cat_totals$Species == "Gracilaria seaweeds"] <- "Gracilaria gracilis"
cat_totals$Species[cat_totals$Species == "Green mud crab"] <- "Scylla paramamosain" 
cat_totals$Species[cat_totals$Species == "Indo-Pacific swamp crab"] <- "Scylla serrata"
cat_totals$Species[cat_totals$Species == "Japanese carpet shell"] <- "Ruditapes philippinarum"
cat_totals$Species[cat_totals$Species == "Japanese kelp"] <- "Laminaria japonica"

cat_totals$Species[cat_totals$Species == "Laver (Nori)"] <- "Porphyra"
cat_totals$Species[cat_totals$Species == "Mediterranean mussel"] <- "Mytilus galloprovincialis"
cat_totals$Species[cat_totals$Species == "New Zealand mussel"] <- "Perna canaliculus"

cat_totals$Species[cat_totals$Species == "Oriental river prawn" ] <- "Macrobrachium nipponense"
cat_totals$Species[cat_totals$Species == "Pacific cupped oyster"] <- "Magallana gigas"
cat_totals$Species[cat_totals$Species == "Red swamp crawfish"] <- "Procambarus clarkii"
cat_totals$Species[cat_totals$Species == "Spiny eucheuma"] <- "Eucheuma denticulatum"
cat_totals$Species[cat_totals$Species == "Wakame"] <- "Undaria pinnatifida"
cat_totals$Species[cat_totals$Species == "Whiteleg shrimp"] <- "Penaeus vannamei"
cat_totals$Species[cat_totals$Species == "Yesso scallop" ] <- "Mizuhopecten yessoensis"
```

```{r}
#put rows in alphabetical order
cat_totals <- cat_totals[order(cat_totals$Species), ]
```

PRODUCTION TOTALS by COUNTRY
```{r}
str(cat_totals)

cat_totals <- cat_totals %>%mutate_at(c(3:74), as.numeric) #change yearly data to numeric
names(cat_totals)[2] <- "Country" #rename continent column

new_frame <- cat_totals #create new frame
new_frame <- new_frame[FALSE, ]

#now add the totals for other categories
#create list of each continent to loop through
unique <- c("China", "Canada") 

for (i in 1:length(unique)){ #for each of the countries
  u_cont <- filter(cat_totals, Country == unique[i])
  
#calculate the annual mean each year

  for (b in 3:74){
    a <- sum(u_cont[, b], na.rm = TRUE)
    print(a)
    new_frame[i, 2] <- unique[i]
    new_frame[i, b] <-a #change row number 
  }
}

new_frame <- new_frame[, c(2, 3:74)] #cut out unnecessary columns

#save this data
NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Fuzzy/category_totals_CH_CA.csv")
write.csv(new_frame,file=NAME)
```

START HERE
```{r}
#load in the FCB scores data
speciesdata <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/FCB_scores.csv")

#rename (inland and marine) for nile tilapia and rainbow trout
speciesdata$species[34] <- "Oncorhynchus mykiss (inland)"
speciesdata$species[35] <- "Oncorhynchus mykiss (marine)"
speciesdata$species[36] <- "Oreochromis niloticus (inland)"
speciesdata$species[37] <- "Oreochromis niloticus (marine)"

#find which species are in both this species dataset AND the China/Canada one
library(generics)
data_common1 <- generics::intersect(speciesdata[, 2], cat_totals[, 1])
data_common1

data_common1[1:33]

#reduce species data down to just these species
new_frame <- speciesdata #create new frame
new_frame <- new_frame[FALSE, ]
for (i in 1:33) { 
  index <- filter(speciesdata, species == data_common1[i]) #add new row/species to the frame
  print(index)
  new_frame[i,] <- index   #add these numbers to the frame
}

speciesdata <- new_frame
```

```{r}
#load in the totals
totals <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/category_totals_CH_CA.csv")
totals <- totals[, c(-1)]
```

WEIGHTED BY ALL PRODUCTION (change this for B and C)
```{r}
#calculate index scores for each species weighted by production of ALL 55 species
#CHANGE FOR B AND C

new_frame <- cat_totals #create new frame
new_frame <- new_frame[FALSE, ]

for (i in 1:nrow(speciesdata)){ #for each species
  # print(speciesdata$species[i])
  y <- nrow(new_frame) #reset nrow

  sp <- speciesdata$species[i] #get one species
  f_score <- speciesdata$b[i] #get the score for the species, CHANGE FOR B AND C!!!!  must == sp


  set <- filter(cat_totals, Species == sp, ) #create new set with just the species of choice

    for (z in 1:nrow(set)) { #for each row in the species set
    for (b in 3:74) { #for each year

      index <- f_score*set[z, b] #multiply score by that species' total production in each year

      print(index)
      new_frame[y+z, b] <- index   #add these numbers to the frame
      new_frame[y+z, 1] <- speciesdata[i, 2] #add species
      new_frame[y+z, 2] <- set$Country[z] #add country

      }
    }
}

#try this after the loop

v <- new_frame[1,3]/totals[1,2]
v

for (i in 1:nrow(new_frame)) { #for each row

for (b in 3:74) { #for each year

      if(is.na(new_frame$Country[i])) {x=FALSE
    } else if (new_frame$Country[i] == "China") {
      index <- new_frame[i, b]/totals[1, b-1]
    } else
      index <- new_frame[i, b]/totals[2, b-1]

    print(index)

    new_frame[i, b] <- index   #add these numbers to the frame
    # new_frame[y+z, 1] <- speciesdata[i, 2] #add species
    # new_frame[y+z, 2] <- set$Country[z] #add continent
}
}

```


```{r}
#calculate the annual mean each year, for each country
weighted_indexes <- new_frame #create new frame
weighted_indexes <- weighted_indexes[FALSE, ]

#select one continent at a time, then sum all values for each year
#create list of each continent to loop through
unique <- c("China", "Canada") 

for (i in 1:length(unique)){ #for each of the continents
  u_cont <- filter(new_frame, Country == unique[i], )
  y <- nrow(new_frame) #reset nrow
  
#calculate the annual mean each year
  for (b in 3:74){
    a <- sum(u_cont[, b], na.rm = TRUE)
    print(a)
    
    #how to store?
    weighted_indexes[i, b] <- a   #add these numbers to the frame
    weighted_indexes[i, 2] <- unique[i] #add continent
  }
}

weighted_indexes <- weighted_indexes[, 2:74] #new frame with just the weighted scores each year
```

GETTING READY TO GRAPH
```{r}
#separate out the continents
china <- weighted_indexes[1, ]
canada <- weighted_indexes[2, ]

library(tidyr)
#make long, change for each country
canada <- pivot_longer(canada, cols = c(!Country), 
                                names_to = "Year", values_to = "Score")


canada <- canada[order(canada$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)


#rename year column in weighted_indexes
for (i in 1:nrow(canada)) {
  print(canada$Year[i])
  #replace each year with the actual year number from year_labs
  
  canada$Year[i] <- year_labs[i]
}

canada$Year <- as.numeric(canada$Year) #make years numeric

#NOW CHINA

china <- pivot_longer(china, cols = c(!Country), 
                                names_to = "Year", values_to = "Score")


china <- china[order(china$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)


#rename year column in weighted_indexes
for (i in 1:nrow(china)) {
  print(china$Year[i])
  #replace each year with the actual year number from year_labs
  
  china$Year[i] <- year_labs[i]
}

china$Year <- as.numeric(china$Year) #make years numeric
```

```{r}
#graphing this
library(ggplot2)
setwd("/Users/aleahw/Documents/Master's!!/Fuzzy/Figures")


ggplot(china, aes(x=Year, y=Score)) +geom_point()+
  labs(y = "Mean Biodiversity Index", title = "Biodiversity Potential of Aquaculture in China")+
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))


# ggsave("C_China_V2.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set

```

#combining all continents into one graph?
```{r}
#combining all continents into one graph?

#make long
weighted_indexes <- pivot_longer(weighted_indexes, cols = c(!Country),
                                names_to = "Year", values_to = "Score")


weighted_indexes <- weighted_indexes[order(weighted_indexes$Year),] #put earlier years first
# 
year_labs <- seq(1950, 2021, by = 1)
year_labs

#make alphabetical so all years for one continent are together
weighted_indexes <- weighted_indexes[order(weighted_indexes$Country), ]


#rename year column in weighted_indexes for canada
for (i in 1:72) {
  print(weighted_indexes$Year[i])
  #replace each year with the actual year number from year_labs

  weighted_indexes$Year[i] <- year_labs[i]
}

weighted_indexes$Year <- as.numeric(weighted_indexes$Year) #make years numeric

#rename years for china
for (i in 73:144) {
  print(weighted_indexes$Year[i-72])
  #replace each year with the actual year number from year_labs

  weighted_indexes$Year[i] <- year_labs[i-72]
}

weighted_indexes$Year <- as.numeric(weighted_indexes$Year) #make years numeric
```

GRAPHING
```{r}
#ALL YEARS
plot <- ggplot(weighted_indexes, aes(x=Year, y=Score, color = Country)) +geom_line(size =1)+
  labs(y = "Mean Biodiversity Index", title = "Biodiversity Potential of Aquaculture")+
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))+

      scale_color_manual(values=c('#7D627F', '#7DBBC3'))

# #SAVE
ggsave("B_China_Canada.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set

#just the 20-year version:
plot <- ggplot(weighted_indexes, aes(x=Year, y=Score, color = Country)) +geom_line(size =1)+
  labs(y = "Mean Biodiversity Index", title = "Biodiversity Potential of Aquaculture")+
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))+
  
      scale_color_manual(values=c('#7D627F', '#7DBBC3'))+
        xlim(2000, 2021)

#SAVE
ggsave("B_China_Canada_2000-2021.png", plot, height = 5, width = 8, dpi = 600) #make sure wd is set
```

```{r}
#making shorter time scale plots
```



```{r}
# #load in the country data one by one, combine into one big dataset
# setwd("/Users/aleahw/Documents/Master's!!/Production_data/all_countries")
# countries <- list.files("/Users/aleahw/Documents/Master's!!/Production_data/all_countries")
# countries
# 
# for (i in 1) { #to initialize the new dataframe
#   name <- countries[i]
#   
#   country <- read.csv(paste("/Users/aleahw/Documents/Master's!!/Production_data/all_countries", name, sep="/"), header = FALSE)
#   
#   colnames(country)<-country[1,]
#   country<-country[-1,]
#   new_frame <- country
# }
# 
# # #NOW ADD each country's data to the new dataframe, starting with the second country
# for (i in c(2:(length(countries)))) {
#     name <- countries[i]
#   
#   country <- read.csv(paste("/Users/aleahw/Documents/Master's!!/Production_data/all_countries", name, sep="/"), header = FALSE)
#   
#   colnames(country)<-country[1,]
#   country<-country[-1,]
# 
# #   #now add each one to the existing frame
#   country_new <-country
# 
# #   #add this each time to new_frame
#   new_frame<- bind_rows(new_frame, country_new)
# }
# 
# 
# #calculate the total production in each year
# # data.frame(new_frame)
# # str(new_frame)
# new_frame <- new_frame %>% mutate_at(c(7:72), as.numeric)
# 
# for (i in 7:72){
#   a<- sum(new_frame[, i], na.rm = TRUE)
#   # a<- sum(new_frame$i)
#   new_frame[8789, i] <- a
#   
# }
```

```{r}
# #load in species data with f scores, get taxon key
# speciesdata <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/FCB_scoresv2.csv")
# 
# #example for 600080, chanos
# #filter out just these rows from the production data
# example<- new_frame[new_frame$Taxonkey == '600080', ]
# 
# #find total production of that species in each year
# for (i in 7:72){
#   a<- sum(example[, i], na.rm = TRUE)
#   # a<- sum(new_frame$i)
#   example[68, i] <- a
#   
# }
# 
# #multiply F score by production of each species in each year
# f_score <- speciesdata$f[3]
# 
# for (i in 7:72){
#   index <- f_score*example[68, i]
#   index <- index/(new_frame[8789, i]) #no commas
#   example[69, i] <- index
#   #add these numbers to the frame
# }
# 
# 
# #example: for each species, and for each year, calculate the weighted index of production

```