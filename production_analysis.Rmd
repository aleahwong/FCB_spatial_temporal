---
title: "Production_analysis"
author: "Aleah Wong"
date: '2023-05-02'
output: html_document
---

Something changed with the algae and finfish graphs...something is wrong
```{r}
rm(list = ls())
.rs.restartR()
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```

```{r}
#load in FAO data, calculate total production in each year

inland <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/inland_finfish_prod.csv")
marine <-read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/marine_finfish_prod.csv")
nonfish <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/nonfish_prod.csv")
# totals <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/totals_bycategory_prod.csv") #don't need this...it includes species not included in analysis
```

```{r}
#calculate annual production totals for each inland species
str(inland)
inland <- inland %>%mutate_at(c(6:77), as.numeric) #change yearly data to numeric

# unique(inland$ASFIS.species.Name.En) #find unique species in data
#create list of each species to loop through
unique <- c("Bighead carp", "Black carp", "Catla", "Common carp", "Crucian carp", "Grass carp(=White amur)", "Largemouth black bass", "Nile tilapia", "Rainbow trout", "Roho labeo", "Silver carp", "Striped catfish", "Wuchang bream") 

new_frame <- filter(inland, ASFIS.species.Name.En == unique[1]) #create new frame
new_frame <- new_frame[FALSE, ]

for (i in 1:length(unique)){ #for each of the species
  u_species <- filter(inland, ASFIS.species.Name.En == unique[i])
  
#calculate the annual mean each year

  for (b in 6:77){
    a <- sum(u_species[, b], na.rm = TRUE)
    print(a)
    new_frame[i, 1] <- unique[i]
    new_frame[i, b] <-a #change row number 
  }
}

new_frame <- new_frame[, c(1, 6:77)] #cut out unnecessary columns
names(new_frame)[1] <- "Species" #rename first column

#save this data
NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Fuzzy/inland_totals.csv")
write.csv(new_frame,file=NAME)
```

```{r}
#calculate annual production totals for each marine species
# str(marine)
marine <- marine %>%mutate_at(c(6:77), as.numeric) #change yearly data to numeric

unique(marine$ASFIS.species.Name.En) #find unique species in data

#create list of each species to loop through
unique <- c("Atlantic salmon", "Barramundi(=Giant seaperch)", "Coho(=Silver) salmon", "European seabass", "Flathead grey mullet", "Gilthead seabream", "Japanese amberjack", "Japanese seabass", "Large yellow croaker", "Milkfish", "Nile tilapia", "Orange-spotted grouper", "Red drum") 

new_frame <- filter(marine, ASFIS.species.Name.En == unique[1]) #create new frame
new_frame <- new_frame[FALSE, ]

for (i in 1:length(unique)){ #for each of the species
  u_species <- filter(marine, ASFIS.species.Name.En == unique[i])
  
#calculate the annual mean each year

  for (b in 6:77){
    a <- sum(u_species[, b], na.rm = TRUE)
    print(a)
    new_frame[i, 1] <- unique[i]
    new_frame[i, b] <-a #change row number 
  }
}

new_frame <- new_frame[, c(1, 6:77)] #cut out unnecessary columns
names(new_frame)[1] <- "Species" #rename first column

#save this data
NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Fuzzy/marine_totals.csv")
write.csv(new_frame,file=NAME)
```


```{r}
#calculate annual production totals for each nonfish species
# str(marine)
nonfish <- nonfish %>%mutate_at(c(6:77), as.numeric) #change yearly data to numeric

unique(nonfish$ASFIS.species.Name.En) #find unique species in data

#create list of each species to loop through
unique <- c("Blood cockle", "Blue mussel", "Chilean mussel", "Chinese mitten crab", "Constricted tagelus", "Elkhorn sea moss", "Eucheuma seaweeds nei", "Fusiform sargassum", "Giant river prawn", "Giant tiger prawn", "Gracilaria seaweeds", "Green mud crab", "Indo-Pacific swamp crab", "Japanese carpet shell", "Japanese kelp", "Laver (Nori)", "Mediterranean mussel", "New Zealand mussel", "Nori nei", "Oriental river prawn", "Pacific cupped oyster", "Red swamp crawfish", "Scallops nei", "Sea mussels nei", "Spiny eucheuma", "Wakame", "Whiteleg shrimp", "Yesso scallop") 

new_frame <- filter(nonfish, ASFIS.species.Name.En == unique[1]) #create new frame
new_frame <- new_frame[FALSE, ]

for (i in 1:length(unique)){ #for each of the species
  u_species <- filter(nonfish, ASFIS.species.Name.En == unique[i])
  
#calculate the annual mean each year

  for (b in 6:77){
    a <- sum(u_species[, b], na.rm = TRUE)
    print(a)
    new_frame[i, 1] <- unique[i]
    new_frame[i, b] <-a #change row number 
  }
}

new_frame <- new_frame[, c(1, 6:77)] #cut out unnecessary columns
names(new_frame)[1] <- "Species" #rename first column

#save this data
NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Fuzzy/nonfish_totals.csv")
write.csv(new_frame,file=NAME)
```

START HERE (above code saved in csv files)
```{r}
#calculating weighted index scores

#load data
setwd("/Users/aleahw/Documents/Master's!!/Fuzzy/production_totals")
# category_totals <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/production_totals/category_totals.csv") #this needs to be updated bc it was calculated from other species not used in the analysis. but it is used to create an empty frame?


inland_totals <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/production_totals/inland_totals.csv")
marine_totals <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/production_totals/marine_totals.csv")
nonfish_totals <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/production_totals/nonfish_totals.csv")
nonfish_totals <- nonfish_totals[, c(-75)]

#rename (inland and marine) for nile tilapia and rainbow trout
inland_totals$Species[inland_totals$Species == "Rainbow trout"] <- "Oncorhynchus mykiss (inland)"
inland_totals$Species[inland_totals$Species == "Nile tilapia"] <- "Oreochromis niloticus (inland)"

#rename (inland and marine) for nile tilapia and rainbow trout
marine_totals$Species[marine_totals$Species == "Rainbow trout"] <- "Oncorhynchus mykiss (marine)"
marine_totals$Species[marine_totals$Species == "Nile tilapia"] <- "Oreochromis niloticus (marine)"

#remove random extra column in category_totals
# category_totals <- category_totals[, c(-1)]

#combine the datasets with rowbind
cat_totals <- rbind(inland_totals, marine_totals)
cat_totals <- rbind(cat_totals, nonfish_totals)
cat_totals <- cat_totals[, c(-1)]

#rename pompano, get rid of nori nei, scallops nei and sea mussels nei
cat_totals <- cat_totals[!cat_totals$Species == "Nori nei",]
cat_totals <- cat_totals[!cat_totals$Species == "Scallops nei",]
cat_totals <- cat_totals[!cat_totals$Species == "Sea mussels nei",]
```

```{r}
#put both datasets into the same order so the species line up
#rename the cat_totals species to be scientific names

cat_totals$Species[cat_totals$Species == "American cupped oyster"] <- "Crassostrea virginica"
cat_totals$Species[cat_totals$Species == "North African Catfish"] <- "Clarias gariepinus"
cat_totals$Species[cat_totals$Species == "Pompano"] <- "Trachinotus ovatus"

cat_totals$Species[cat_totals$Species == "Black carp"] <- "Mylopharyngodon piceus"
cat_totals$Species[cat_totals$Species == "Bighead carp"] <- "Hypophthalmichthys nobilis"
cat_totals$Species[cat_totals$Species == "Catla"] <- "Catla catla"
cat_totals$Species[cat_totals$Species == "Common carp"] <- "Cyprinus carpio"
cat_totals$Species[cat_totals$Species == "Crucian carp"] <- "Carassius carassius"
cat_totals$Species[cat_totals$Species == "Grass carp(=White amur)"] <- "Ctenopharyngodon idella"
cat_totals$Species[cat_totals$Species == "Largemouth black bass"] <- "Micropterus salmoides"
cat_totals$Species[cat_totals$Species == "Nile tilapia"] <- "Oreochromis niloticus"
cat_totals$Species[cat_totals$Species == "Rainbow trout"] <- "Oncorhynchus mykiss"
cat_totals$Species[cat_totals$Species == "Roho labeo"] <- "Labeo rohita"
cat_totals$Species[cat_totals$Species == "Silver carp"] <- "Hypophthalmichthys molitrix"
cat_totals$Species[cat_totals$Species == "Striped catfish"] <- "Pangasianodon hypophthalmus"
cat_totals$Species[cat_totals$Species == "Wuchang bream"] <- "Megalobrama amblycephala"
cat_totals$Species[cat_totals$Species == "Atlantic salmon"] <- "Salmo salar"
cat_totals$Species[cat_totals$Species == "Barramundi(=Giant seaperch)"] <- "Lates calcarifer"
cat_totals$Species[cat_totals$Species == "Coho(=Silver) salmon"] <- "Oncorhynchus kisutch"
cat_totals$Species[cat_totals$Species == "European seabass"] <- "Dicentrarchus labrax"
cat_totals$Species[cat_totals$Species == "Flathead grey mullet"] <- "Mugil cephalus"
cat_totals$Species[cat_totals$Species == "Gilthead seabream"] <- "Sparus aurata"
cat_totals$Species[cat_totals$Species == "Japanese amberjack"] <- "Seriola quinqueradiata"
cat_totals$Species[cat_totals$Species == "Japanese seabass"] <-  "Lateolabrax japonicus"
cat_totals$Species[cat_totals$Species == "Large yellow croaker"] <- "Larimichthys croceus"
cat_totals$Species[cat_totals$Species == "Milkfish"] <- "Chanos chanos"
cat_totals$Species[cat_totals$Species == "Nile tilapia"] <- "Oreochromis niloticus"
cat_totals$Species[cat_totals$Species == "Orange-spotted grouper"] <- "Epinephelus coioides"
cat_totals$Species[cat_totals$Species == "Red drum"] <- "Sciaenops ocellatus"
cat_totals$Species[cat_totals$Species == "Blood cockle"] <- "Tegillarca granosa"
cat_totals$Species[cat_totals$Species == "Blue mussel" ] <- "Mytilus edulis"
cat_totals$Species[cat_totals$Species == "Chilean mussel"] <- "Mytilus chilensis"
cat_totals$Species[cat_totals$Species == "Chinese mitten crab" ] <- "Eriocheir sinensis"
cat_totals$Species[cat_totals$Species == "Constricted tagelus"] <- "Sinonovacula constricta"
cat_totals$Species[cat_totals$Species == "Elkhorn sea moss"] <- "Kappaphycus alvarezii"

cat_totals$Species[cat_totals$Species == "Eucheuma seaweeds nei"] <- "Eucheuma cottonii"
cat_totals$Species[cat_totals$Species == "Fusiform sargassum"] <- "Sargassum fusiforme"
cat_totals$Species[cat_totals$Species == "Giant river prawn"] <- "Macrobrachium rosenbergii"
cat_totals$Species[cat_totals$Species == "Giant tiger prawn"] <- "Penaeus monodon"

# cat_totals$Species[cat_totals$Species == "Gracilaria seaweeds"] <- "Gracilaria gracilis" 
cat_totals$Species[cat_totals$Species == "Green mud crab"] <- "Scylla paramamosain" 
cat_totals$Species[cat_totals$Species == "Indo-Pacific swamp crab"] <- "Scylla serrata"
cat_totals$Species[cat_totals$Species == "Japanese carpet shell"] <- "Ruditapes philippinarum"
cat_totals$Species[cat_totals$Species == "Japanese kelp"] <- "Laminaria japonica"

cat_totals$Species[cat_totals$Species == "Laver (Nori)"] <- "Porphyra"
cat_totals$Species[cat_totals$Species == "Mediterranean mussel"] <- "Mytilus galloprovincialis"
cat_totals$Species[cat_totals$Species == "New Zealand mussel"] <- "Perna canaliculus"

cat_totals$Species[cat_totals$Species == "Oriental river prawn" ] <- "Macrobrachium nipponense"
cat_totals$Species[cat_totals$Species == "Pacific cupped oyster"] <- "Magallana gigas"
cat_totals$Species[cat_totals$Species == "Red swamp crawfish"] <- "Procambarus clarkii"
cat_totals$Species[cat_totals$Species == "Spiny eucheuma"] <- "Eucheuma denticulatum"
cat_totals$Species[cat_totals$Species == "Wakame"] <- "Undaria pinnatifida"
cat_totals$Species[cat_totals$Species == "Whiteleg shrimp"] <- "Penaeus vannamei"
cat_totals$Species[cat_totals$Species == "Yesso scallop" ] <- "Mizuhopecten yessoensis"

#extra 2 porphyra in species data, create triplicate
cat_totals <- rbind(cat_totals, cat_totals[rep(45, 2), ])

#put rows in alphabetical order
cat_totals <- cat_totals[order(cat_totals$Species), ]

#renaming in cat_totals so cat_totals matches spp_list and they can be merged
cat_totals$Species[6] <- "Ctenopharyngodon idellus"

cat_totals$Species[42] <- "Porphrya tenera"
cat_totals$Species[43] <- "Porphyra haitanensis"
cat_totals$Species[44] <- "Porphyra yezoensis"

cat_totals$Species[13] <- "Gracilaria gracilis"
```

```{r}
#check
v <- unique(nonfish$ASFIS.species.Name.En) #29

# v <- unique(nonfish_totals_cont$Species)

v <- unique(cat_totals$Species) #57
```

```{r}
#load in the FCB scores data
speciesdata <- read.csv("/Users/aleahw/Documents/Master's!!/Fuzzy/FCB_scores_825.2.csv") #edit this

#alphabetical order:
speciesdata <- speciesdata[order(speciesdata$species), ]


#rename (inland and marine) for nile tilapia and rainbow trout
speciesdata$species[34] <- "Oncorhynchus mykiss (inland)"
speciesdata$species[35] <- "Oncorhynchus mykiss (marine)"
speciesdata$species[36] <- "Oreochromis niloticus (inland)"
speciesdata$species[37] <- "Oreochromis niloticus (marine)"
```

MERGE
```{r}
#create species and type from speciesdata, bind with category totals by species

spplist <- speciesdata[, c("species", "category")]
names(cat_totals)[1] <- "species" #check this bc u use "Species" later on...

test <- merge(spplist, cat_totals, by="species")
```

CALCULATING PRODUCTION BY ALL, then by INVERTS, then PLANTS, then FISH
```{r}

frame <- test[, c(1, 3:74)]

weighting_totals <- frame #create new frame
weighting_totals <- weighting_totals[FALSE, ]

#use "cat_totals" for total of all spp
for (i in 2:ncol(cat_totals)){ #for each year
  # print(test[1, i])
  #sum the columns into a new row
  a <- sum(cat_totals[, i], na.rm = TRUE)
  print(a)
  weighting_totals[1, i] <- a
  
}
#rename
weighting_totals[1, 1] <- "all species" 

#Calculate finfish totals
#filter out just the finfish from "test" dataframe
test2 <- filter(test, category =="finfish_inland"| category =="finfish_marine")

#remove the category column so that this dataframe and the weighting_totals dataframe line up
test2 <- test2[-c(2)]

for (i in 2:ncol(test2)){ #for each year
  #sum the columns into a new row
  a <- sum(test2[, i], na.rm = TRUE)
  print(a)
  weighting_totals[2, i] <- a #second row for this total
  
}

weighting_totals[2, 1] <- "finfish" #rename

#Calculate invert totals
#filter out just the inverts
test2 <- filter(test, category =="mollusc"| category =="crustacean")

#remove the category column so that this dataframe and the weighting_totals dataframe line up
test2 <- test2[-c(2)]

for (i in 2:ncol(test2)){ #for each year
  #sum the columns into a new row
  a <- sum(test2[, i], na.rm = TRUE)
  print(a)
  weighting_totals[3, i] <- a #third row for the inverts total
  
}

weighting_totals[3, 1] <- "inverts" #rename

#Calculate algae totals
#filter out just the algae
test2 <- filter(test, category =="algae")

#remove the category column so that this dataframe and the weighting_totals dataframe line up
test2 <- test2[-c(2)]

for (i in 2:ncol(test2)){ #for each year
  #sum the columns into a new row
  a <- sum(test2[, i], na.rm = TRUE)
  print(a)
  weighting_totals[4, i] <- a #fourth row for the algae total
  
}

weighting_totals[4, 1] <- "algae" #rename
```

WEIGHTED BY ALL PRODUCTION (change for B and C)
```{r}
#calculate index scores for each species weighted by production of ALL 55 species
#CHANGE FOR B AND C

new_frame <- frame #create new frame
new_frame <- new_frame[FALSE, ]

#loop through each species and multiply f score by (production of that species/production of all species)
#cat_totals (production in THOUSANDS of tons) and speciesdata (f scores) align

for (i in 1:nrow(speciesdata)){ #for each species
  print(speciesdata$species[i])
  f_score <- speciesdata$f[i] #get the score, CHANGE FOR B AND C
  
  for (b in 2:73){ #for each year
  index <- f_score*cat_totals[i, b] #multiply score by that species' total production in each year
  index <- index/(weighting_totals[1, b]) #weight by production of ALL species
  
  new_frame[i, b] <- index   #add these numbers to the frame
  new_frame[i, 1] <- speciesdata[i, 2]#include species
  } 
  
}

#calculate the annual mean each year

for (i in 2:73){
    a <- sum(new_frame[, i], na.rm = TRUE) #sum all the columns
    print(a)
    
    new_frame[58, i] <- a
}

new_frame[58, 1] <- "Weighted Index" #name the newest row
weighted_indexes <- new_frame[58, 2:73] #new frame with just the weighted scores each year

library(tidyr)
#make long
weighted_indexes <- pivot_longer(weighted_indexes, cols = everything(), 
                                names_to = "Year", values_to = "Score")

weighted_indexes <- weighted_indexes[order(weighted_indexes$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)

#rename year column in weighted_indexes
for (i in 1:nrow(weighted_indexes)) {
  print(weighted_indexes$Year[i])
  #replace each year with the actual year number from year_labs
  
  weighted_indexes$Year[i] <- year_labs[i]
}

weighted_indexes$Year <- as.numeric(weighted_indexes$Year) #make years numeric

#graphing this
library(ggplot2)
setwd("/Users/aleahw/Documents/Master's!!/Fuzzy/Figures")

ggplot(weighted_indexes, aes(x=Year, y=Score)) +geom_point()+
labs(y = "Mean Food Security Index of Aquaculture Production", title = "Food Security Potential Weighted by Production of 55 Major Aquaculture Species") +
    # theme_classic() +
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))+
      scale_x_continuous(name="Year", 
                         breaks = c(1950, 1960, 1970, 1980, 1990, 2000, 2010, 2020), 
                         label = c("1950", "1960", "1970", "1980", "1990", "2000", "2010", "2020"))
     # + scale_y_continuous(limits = c(50, 60), breaks = c(50, 60))

#SAVE
# ggsave("F_weighted_all.png", plot, height = 5, width = 8, dpi = 600) #make sure wd is set
```


WEIGHTED BY FINFISH
```{r}
#FOOD weighted by finfish, change for B and C
new_frame <- frame #create new frame
new_frame <- new_frame[FALSE, ]

#loop through each FINFISH species and multiply f score by (production of that species/production of all species)
#cat_totals (production in THOUSANDS of tons) and speciesdata (f scores) align

speciesdata2 <- filter(speciesdata, category == "finfish_inland" | category =="finfish_marine") #filter out just the finfish

test2 <- filter(test, category =="finfish_inland"| category =="finfish_marine")

for (i in 1:nrow(speciesdata2)){ #for each species
  f_score <- speciesdata2$f[i] #get the score #CHANGE THIS FOR B AND C
  
  for (b in 2:73){ #for each year
  index <- f_score*test2[i, b+1] #multiply score by that species' total production in each year, b+1 because column two is category
  index <- index/(weighting_totals[2, b]) #weight by production of finfish
  
  new_frame[i, b] <- index   #add these numbers to the frame
  new_frame[i, 1] <- speciesdata2[i, 2]#include species
  } 
  
}

#calculate the annual mean each year
for (i in 2:73){
    a <- sum(new_frame[, i], na.rm = TRUE) #sum all the columns
    print(a)
    
    new_frame[58, i] <- a
}

new_frame[58, 1] <- "Weighted Index" #name the newest row
weighted_indexes1 <- new_frame[58, 2:73] #new frame with just the weighted scores each year

library(tidyr)
#make long
weighted_indexes1 <- pivot_longer(weighted_indexes1, cols = everything(), 
                                names_to = "Year", values_to = "Score")

weighted_indexes1 <- weighted_indexes1[order(weighted_indexes1$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)

#rename year column in weighted_indexes
for (i in 1:nrow(weighted_indexes1)) {
  print(weighted_indexes1$Year[i])
  #replace each year with the actual year number from year_labs
  
  weighted_indexes1$Year[i] <- year_labs[i]
}

weighted_indexes1$Year <- as.numeric(weighted_indexes1$Year) #make years numeric

#graphing this
library(ggplot2)
setwd("/Users/aleahw/Documents/Master's!!/Fuzzy/Figures")

ggplot(weighted_indexes1, aes(x=Year, y=Score)) +geom_point()+
labs(y = "Mean F Index of Aquaculture Production", title = "F Potential Weighted by Finfish Production") +
    # theme_classic() +
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))

#SAVE
# ggsave("B_weighted_finfish.png", plot, height = 5, width = 8, dpi = 600) #make sure wd is set
```

WEIGHTED BY ALGAE
```{r}
#FOOD weighted by algae, change for B and C
new_frame <- frame #create new frame
new_frame <- new_frame[FALSE, ]

#loop through each ALGAE species and multiply f score by (production of that species/production of all species)
#test (production in THOUSANDS of tons) and speciesdata (f scores) align

speciesdata2 <- filter(speciesdata, category == "algae") #filter out just the algae

test2 <- filter(test, category =="algae")

for (i in 1:nrow(speciesdata2)){ #for each species
  # print(speciesdata$species[i])
  f_score <- speciesdata2$f[i] #get the score #CHANGE THIS FOR B AND C
  
  for (b in 2:73){ #for each year
  index <- f_score*test2[i, b+1] #multiply score by that species' total production in each year, b+1 because column two is category, need to start at column 3
  index <- index/(weighting_totals[4, b]) #weight by production of algae, row 4
  
  new_frame[i, b] <- index   #add these numbers to the frame
  new_frame[i, 1] <- speciesdata2[i, 2]#include species
  } 
  
}

#calculate the annual mean each year

for (i in 2:73){
    a <- sum(new_frame[, i], na.rm = TRUE) #sum all the columns
    print(a)
    
    new_frame[58, i] <- a
}

new_frame[58, 1] <- "Weighted Index" #name the newest row
weighted_indexes2 <- new_frame[58, 2:73] #new frame with just the weighted scores each year

library(tidyr)
#make long
weighted_indexes2 <- pivot_longer(weighted_indexes2, cols = everything(), 
                                names_to = "Year", values_to = "Score")

weighted_indexes2 <- weighted_indexes2[order(weighted_indexes2$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)

#rename year column in weighted_indexes
for (i in 1:nrow(weighted_indexes2)) {
  print(weighted_indexes2$Year[i])
  #replace each year with the actual year number from year_labs
  
  weighted_indexes2$Year[i] <- year_labs[i]
}

weighted_indexes2$Year <- as.numeric(weighted_indexes2$Year) #make years numeric

#graphing this
library(ggplot2)

ggplot(weighted_indexes2, aes(x=Year, y=Score)) +geom_point()+
labs(y = "Mean f Index of Aquaculture Production", title = "f Potential Weighted by Algae Production") +
    # theme_classic() +
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))

#SAVE
# ggsave("B_weighted_algae_V2.png", plot, height = 5, width = 8, dpi = 600) #make sure wd is set
```

WEIGHTED BY INVERTS
```{r}
#FOOD weighted by inverts, change for B and C
new_frame <- frame #create new frame
new_frame <- new_frame[FALSE, ]

#loop through each INVERT species and multiply f score by (production of that species/production of all species)
#test (production in THOUSANDS of tons) and speciesdata (f scores) align

speciesdata2 <- filter(speciesdata, category == "crustacean" | category == "mollusc") #filter out just the algae

test2 <- filter(test, category == "crustacean" | category == "mollusc")

for (i in 1:nrow(speciesdata2)){ #for each species
  f_score <- speciesdata2$f[i] #get the score #CHANGE THIS FOR B AND C
  
  for (b in 2:73){ #for each year
  index <- f_score*test2[i, b+1] #multiply score by that species' total production in each year, b+1 because column two is category, need to start at column 3
  index <- index/(weighting_totals[3, b]) #weight by production of inverts, row 3
  
  new_frame[i, b] <- index   #add these numbers to the frame
  new_frame[i, 1] <- speciesdata2[i, 2]#include species
  } 
  
}

#calculate the annual mean each year

for (i in 2:73){
    a <- sum(new_frame[, i], na.rm = TRUE) #sum all the columns
    print(a)
    
    new_frame[58, i] <- a
}

new_frame[58, 1] <- "Weighted Index" #name the newest row
weighted_indexes3 <- new_frame[58, 2:73] #new frame with just the weighted scores each year

library(tidyr)
#make long
weighted_indexes3 <- pivot_longer(weighted_indexes3, cols = everything(), 
                                names_to = "Year", values_to = "Score")

weighted_indexes3 <- weighted_indexes3[order(weighted_indexes3$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)

#rename year column in weighted_indexes
for (i in 1:nrow(weighted_indexes3)) {
  print(weighted_indexes3$Year[i])
  #replace each year with the actual year number from year_labs
  
  weighted_indexes3$Year[i] <- year_labs[i]
}

weighted_indexes3$Year <- as.numeric(weighted_indexes3$Year) #make years numeric

#graphing this
library(ggplot2)

ggplot(weighted_indexes3, aes(x=Year, y=Score)) +geom_point()+
labs(y = "Mean f Index of Aquaculture Production", title = "f Potential Weighted by Invertebrate Production") +
    # theme_classic() +
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))

#SAVE
# ggsave("B_weighted_inverts_V2.png", plot, height = 5, width = 8, dpi = 600) #make sure wd is set
```

Graph of F, C, B (3) with all taxa on same graph?
Need to re-run above code before running this...for B and C
```{r}
#graph of F, C, B (3) with all taxa on same graph?

#FOOD SECURITY--combine data for each weighting

#weighted_indexes = weighted by all
#need to add identifier column
weighted_indexes$weighted_by <- "All"

#weighted_indexes1 = weighted by finfish
weighted_indexes1$weighted_by <- "Finfish"

#weighted_indexes2 = weighted by algae
weighted_indexes2$weighted_by <- "Algae"

#weighted_indexes3 = weighted by inverts
weighted_indexes3$weighted_by <- "Invertebrates"

#put into one dataframe, all stacked up
merge <- rbind(weighted_indexes, weighted_indexes1)
merge <- rbind(merge, weighted_indexes2)
merge <- rbind(merge, weighted_indexes3)

#trial graph
ggplot(merge, aes(x=Year, y=Score, color = weighted_by)) +geom_line(size =1)+
  labs(y = "Mean f Index", title = "f Potential of Aquaculture")+
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))+
      scale_color_manual(name = "Weighted By", values=c('#7D627F', '#7DBBC3', "pink", "orange"))
        
        

#SAVE
# ggsave("C_weighted_combined.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set

```


#Combining F, C, B for each weighting: run this before graphing
```{r}
#calculate index scores for each species weighted by production of ALL 55 species
#FOOD SECURITY

new_frame <- frame #create new frame
new_frame <- new_frame[FALSE, ]

#loop through each species and multiply f score by (production of that species/production of all species)
#cat_totals (production in THOUSANDS of tons) and speciesdata (f scores) align

for (i in 1:nrow(speciesdata)){ #for each species
  print(speciesdata$species[i])
  f_score <- speciesdata$f[i] #get the FOOD SCORE
  
  for (b in 2:73){ #for each year
  index <- f_score*cat_totals[i, b] #multiply score by that species' total production in each year
  index <- index/(weighting_totals[1, b]) #weight by production of ALL species
  
  new_frame[i, b] <- index   #add these numbers to the frame
  new_frame[i, 1] <- speciesdata[i, 2]#include species
  } 
  
}

#calculate the annual mean each year

for (i in 2:73){
    a <- sum(new_frame[, i], na.rm = TRUE) #sum all the columns
    print(a)
    
    new_frame[58, i] <- a
}

new_frame[58, 1] <- "Weighted Index" #name the newest row
weighted_indexes <- new_frame[58, 2:73] #new frame with just the weighted scores each year

library(tidyr)
#make long
weighted_indexes <- pivot_longer(weighted_indexes, cols = everything(), 
                                names_to = "Year", values_to = "Score")

weighted_indexes <- weighted_indexes[order(weighted_indexes$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)

#rename year column in weighted_indexes
for (i in 1:nrow(weighted_indexes)) {
  print(weighted_indexes$Year[i])
  #replace each year with the actual year number from year_labs
  
  weighted_indexes$Year[i] <- year_labs[i]
}

weighted_indexes$Year <- as.numeric(weighted_indexes$Year) #make years numeric

#CLIMATE CHANGE

new_frame <- frame #create new frame
new_frame <- new_frame[FALSE, ]

#loop through each species and multiply f score by (production of that species/production of all species)
#cat_totals (production in THOUSANDS of tons) and speciesdata (f scores) align

for (i in 1:nrow(speciesdata)){ #for each species
  print(speciesdata$species[i])
  f_score <- speciesdata$c[i] #get the CLIMATE SCORE
  
  for (b in 2:73){ #for each year
  index <- f_score*cat_totals[i, b] #multiply score by that species' total production in each year
  index <- index/(weighting_totals[1, b]) #weight by production of ALL species
  
  new_frame[i, b] <- index   #add these numbers to the frame
  new_frame[i, 1] <- speciesdata[i, 2]#include species
  } 
  
}

#calculate the annual mean each year

for (i in 2:73){
    a <- sum(new_frame[, i], na.rm = TRUE) #sum all the columns
    print(a)
    
    new_frame[58, i] <- a
}

new_frame[58, 1] <- "Weighted Index" #name the newest row
weighted_indexesc <- new_frame[58, 2:73] #new frame with just the weighted scores each year

library(tidyr)
#make long
weighted_indexesc <- pivot_longer(weighted_indexesc, cols = everything(), 
                                names_to = "Year", values_to = "Score")

weighted_indexesc <- weighted_indexesc[order(weighted_indexesc$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)

#rename year column in weighted_indexes
for (i in 1:nrow(weighted_indexesc)) {
  print(weighted_indexesc$Year[i])
  #replace each year with the actual year number from year_labs
  
  weighted_indexesc$Year[i] <- year_labs[i]
}

weighted_indexesc$Year <- as.numeric(weighted_indexesc$Year) #make years numeric

#BIODIV

new_frame <- frame #create new frame
new_frame <- new_frame[FALSE, ]

#loop through each species and multiply f score by (production of that species/production of all species)
#cat_totals (production in THOUSANDS of tons) and speciesdata (f scores) align

for (i in 1:nrow(speciesdata)){ #for each species
  print(speciesdata$species[i])
  f_score <- speciesdata$b[i] #get the BIODIV SCORE
  
  for (b in 2:73){ #for each year
  index <- f_score*cat_totals[i, b] #multiply score by that species' total production in each year
  index <- index/(weighting_totals[1, b]) #weight by production of ALL species
  
  new_frame[i, b] <- index   #add these numbers to the frame
  new_frame[i, 1] <- speciesdata[i, 2]#include species
  } 
  
}

#calculate the annual mean each year

for (i in 2:73){
    a <- sum(new_frame[, i], na.rm = TRUE) #sum all the columns
    print(a)
    
    new_frame[58, i] <- a
}

new_frame[58, 1] <- "Weighted Index" #name the newest row
weighted_indexesb <- new_frame[58, 2:73] #new frame with just the weighted scores each year

library(tidyr)
#make long
weighted_indexesb <- pivot_longer(weighted_indexesb, cols = everything(), 
                                names_to = "Year", values_to = "Score")

weighted_indexesb <- weighted_indexesb[order(weighted_indexesb$Year),] #put earlier years first

year_labs <- seq(1950, 2021, by = 1)

#rename year column in weighted_indexes
for (i in 1:nrow(weighted_indexesb)) {
  print(weighted_indexesb$Year[i])
  #replace each year with the actual year number from year_labs
  
  weighted_indexesb$Year[i] <- year_labs[i]
}

weighted_indexesb$Year <- as.numeric(weighted_indexesb$Year) #make years numeric

```


```{r}
#combining F, C, B for each weighting
# (run above chunks, storing output as weighted_indexesb and weighted_indexesc) 

#WEIGHTED BY ALL (change this for the other groups)
#weighted_indexes = F weighted by all
weighted_indexes$Index <- "Food Security"
#weighted_indexesc = C weighted by all 
weighted_indexesc$Index <- "Climate Change"
#weighted_indexesb = B weighted by all 
weighted_indexesb$Index <- "Biodiversity"

#put into one dataframe, all stacked up
merge <- rbind(weighted_indexes, weighted_indexesc)
merge <- rbind(merge, weighted_indexesb)

#trial graph
ggplot(merge, aes(x=Year, y=Score, color = Index)) +geom_line(size =1)+
  labs(y = "Mean Index", title = "FCB Potential of Aquaculture Weighted by 54 Major Species")+
    theme(axis.text.x = element_text(size = 10), axis.title.y = element_text(size=10))+
      scale_color_manual(name = "Index", values=c('#7D627F', '#7DBBC3', "pink", "orange"))


#SAVE
# ggsave("FCB_weightedby_all.png", plot, height = 4, width = 8, dpi = 600) #make sure wd is set

```

CALCULATING DIVERGENCE
```{r}

#make five time slices, 13 to 14 years each

F1 <- filter(merge, Year < 1965, Index == "Food Security")
F2 <- filter(merge, Year > 1964 & Year < 1979, Index == "Food Security")
F3 <- filter(merge, Year > 1978 & Year < 1993, Index == "Food Security")
F4 <- filter(merge, Year > 1992 & Year < 2007, Index == "Food Security")
F5 <- filter(merge, Year > 2006, Index == "Food Security")

C1 <- filter(merge, Year < 1965, Index == "Climate Change")
C2 <- filter(merge, Year > 1964 & Year < 1979, Index == "Climate Change")
C3 <- filter(merge, Year > 1978 & Year < 1993, Index == "Climate Change")
C4 <- filter(merge, Year > 1992 & Year < 2007, Index == "Climate Change")
C5 <- filter(merge, Year > 2006, Index == "Climate Change")

B1 <- filter(merge, Year < 1965, Index == "Biodiversity")
B2 <- filter(merge, Year > 1964 & Year < 1979, Index == "Biodiversity")
B3 <- filter(merge, Year > 1978 & Year < 1993, Index == "Biodiversity")
B4 <- filter(merge, Year > 1992 & Year < 2007, Index == "Biodiversity")
B5 <- filter(merge, Year > 2006, Index == "Biodiversity")

#make new frame to store values
divergence = data.frame(matrix(
  vector(), 5, 3, dimnames=list(c(), c("B-F","B-C","F-C"))),
                stringsAsFactors=F)
rownames(divergence) <- c("1950-1964","1965-1978","1979-1992","1993-2006", "2007-2021")

#subtract and add values to dataframe
# divergence$B.F[1] <- B1-F1

BF1 <- data.frame(B1$Score - F1$Score)
BF2 <- data.frame(B2$Score - F2$Score)
BF3 <- data.frame(B3$Score - F3$Score)
BF4 <- data.frame(B4$Score - F4$Score)
BF5 <- data.frame(B5$Score - F5$Score)

BC1 <- data.frame(B1$Score - C1$Score)
BC2 <- data.frame(B2$Score - C2$Score)
BC3 <- data.frame(B3$Score - C3$Score)
BC4 <- data.frame(B4$Score - C4$Score)
BC5 <- data.frame(B5$Score - C5$Score)

FC1 <- data.frame(F1$Score - C1$Score)
FC2 <- data.frame(F2$Score - C2$Score)
FC3 <- data.frame(F3$Score - C3$Score)
FC4 <- data.frame(F4$Score - C4$Score)
FC5 <- data.frame(F5$Score - C5$Score)

slice1 <- cbind(BF1, BC1, FC1) #1950-1964
divergence$B.F[1] <- mean(slice1$B1.Score...F1.Score)
divergence$B.C[1] <- mean(slice1$B1.Score...C1.Score)
divergence$F.C[1] <- mean(slice1$F1.Score...C1.Score)

slice2 <- cbind(BF2, BC2, FC2)
divergence$B.F[2] <- mean(slice2$B2.Score...F2.Score)
divergence$B.C[2] <-mean(slice2$B2.Score...C2.Score)
divergence$F.C[2] <- mean(slice2$F2.Score...C2.Score)

slice3 <- cbind(BF3, BC3, FC3)
divergence$B.F[3] <- mean(slice3$B3.Score...F3.Score)
divergence$B.C[3] <- mean(slice3$B3.Score...C3.Score)
divergence$F.C[3] <- mean(slice3$F3.Score...C3.Score)

slice4 <- cbind(BF4, BC4, FC4)
divergence$B.F[4] <- mean(slice4$B4.Score...F4.Score)
divergence$B.C[4] <- mean(slice4$B4.Score...C4.Score)
divergence$F.C[4] <- mean(slice4$F4.Score...C4.Score)

slice5 <- cbind(BF5, BC5, FC5)
divergence$B.F[5] <- mean(slice5$B5.Score...F5.Score)
divergence$B.C[5] <- mean(slice5$B5.Score...C5.Score)
divergence$F.C[5] <- mean(slice5$F5.Score...C5.Score)

#SAVE

# NAME<- sprintf("/Users/aleahw/Documents/Master's!!/Fuzzy/Figures/divergence.csv")
# write.csv(divergence,file=NAME)
```


CHECKING FOR CORRELATION
```{r}
#are F, C, and B correlated?

library("ggpubr")
library(ggplot2)

# Do the data from each of the 2 variables (x, y) follow a normal distribution?
# Use Shapiro-Wilk normality test –> R function: shapiro.test()
# and look at the normality plot —> R function: ggpubr::ggqqplot()

# Shapiro-Wilk test can be performed as follow:
# Null hypothesis: the data are normally distributed
# Alternative hypothesis: the data are not normally distributed

# Shapiro-Wilk normality test for f
shapiro.test(speciesdata$f) # => p = 0.005867 NOT NORMAL (sig diff from normal dist)
# Shapiro-Wilk normality test for c
shapiro.test(speciesdata$c) # => p = 0.1598 NORMAL
# Shapiro-Wilk normality test for b
shapiro.test(speciesdata$b) # => p = 0.000394 NOT NORMAL

# Visual inspection of the data normality using Q-Q plots (quantile-quantile plots). Q-Q plot draws the correlation between a given sample and the normal distribution.

ggqqplot(speciesdata$f, ylab = "Food Security") #these all look normal??
ggqqplot(speciesdata$c, ylab = "Climate Change")
ggqqplot(speciesdata$b, ylab = "Biodiversity")

#histogram to see dist
ggdensity(speciesdata$f, 
          main = "Density plot of F index",
          xlab = "Food Security Index")

ggdensity(speciesdata$c, 
          main = "Density plot of C index",
          xlab = "Climate Change Index")

ggdensity(speciesdata$b, 
          main = "Density plot of B index",
          xlab = "Biodiversity Index")


#PEARSON, assuming normal distribution...
#FOOD SECURITY AND CLIMATE CHANGE
ggscatter(speciesdata, x = "f", y = "c", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Food Security Index", ylab = "Climate Change Index") #SIGNIFICANT, R = 0.53; p = 2.242e-05; 95 percent confidence interval:0.3125252 0.6945929

res <- cor.test(speciesdata$f, speciesdata$c, 
                    method = "pearson")
res

#FOOD SECURITY AND BIODIVERSITY
ggscatter(speciesdata, x = "f", y = "b", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Food Security Index", ylab = "Biodiversity Index") #SIGNIFICANT, R = 0.59; p = 1.742e-06, 95 %conf: 0.3830867 0.7338902

res <- cor.test(speciesdata$f, speciesdata$b, 
                    method = "pearson")
res

#BIODIVERSITY AND CLIMATE CHANGE
ggscatter(speciesdata, x = "c", y = "b", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Climate Change Index", ylab = "Biodiversity Index") #SIGNIFICANT, R = 0.52; p = 3.113e-05; 95% conf:  0.3026715 0.6889176

res <- cor.test(speciesdata$c, speciesdata$b, 
                    method = "pearson")
res

#Spearman rank correlation, assuming non-normal dist
# The Kendall rank correlation coefficient or Kendall’s tau statistic is used to estimate a rank-based measure of association. This test may be used if the data do not necessarily come from a bivariate normal distribution.

res2 <- cor.test(speciesdata$f, speciesdata$c,  method="kendall") #SIG; tau = 0.4173204, p-value = 4.688e-06
res2

res2 <- cor.test(speciesdata$f, speciesdata$b,  method="kendall") #SIG; tau = 0.4496076; p-value = 8.238e-07
res2

res2 <- cor.test(speciesdata$c, speciesdata$b,  method="kendall") #SIG; tau = 0.359071; p-value = 8.212e-05
res2

```
